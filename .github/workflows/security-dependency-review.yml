# Security: Dependency Review
# Reusable workflow for scanning vulnerable dependencies in PRs
#
# Usage:
#   jobs:
#     dependency-review:
#       uses: merglbot-core/github/.github/workflows/security-dependency-review.yml@v2
#       with:
#         fail-on-severity: moderate  # Optional: critical, high, moderate, low
#
# Purpose: Enforce security by scanning all dependency changes in PRs
# Category: Security
# Priority: CRITICAL
# Status: DRAFT
# Created: 2025-11-12 (Enterprise CI Audit)

name: Security - Dependency Review

on:
  workflow_call:
    inputs:
      fail-on-severity:
        description: 'Minimum severity to fail the workflow (critical, high, moderate, low)'
        type: string
        default: 'moderate'
        required: false
      
      deny-licenses:
        description: 'Comma-separated list of licenses to deny (e.g., GPL-3.0,AGPL-3.0)'
        type: string
        default: ''
        required: false
      
      comment-summary-in-pr:
        description: 'Post a comment with the summary in the PR'
        type: boolean
        default: true
        required: false

permissions:
  contents: read

jobs:
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          persist-credentials: false
      
      - name: Run Dependency Review
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261  # v4.8.2
        with:
          fail-on-severity: ${{ inputs.fail-on-severity }}
          deny-licenses: ${{ inputs.deny-licenses }}
          comment-summary-in-pr: ${{ inputs.comment-summary-in-pr }}
          
          # Additional security configurations
          vulnerability-check: true
          license-check: true
          
          # Retry configuration for API rate limits
          retry-on-snapshot-warnings: true
          retry-on-snapshot-warnings-timeout: 600
