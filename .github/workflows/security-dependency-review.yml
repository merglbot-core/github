# Security: Dependency Review
# Reusable workflow for scanning vulnerable dependencies in PRs
#
# Usage:
#   jobs:
#     dependency-review:
#       uses: merglbot-core/github/.github/workflows/security-dependency-review.yml@v2
#       with:
#         fail-on-severity: moderate  # Optional: critical, high, moderate, low
#
# Purpose: Enforce security by scanning all dependency changes in PRs
# Category: Security
# Priority: CRITICAL
# Status: DRAFT
# Created: 2025-11-12 (Enterprise CI Audit)

name: Security - Dependency Review

on:
  workflow_call:
    inputs:
      fail-on-severity:
        description: 'Minimum severity to fail the workflow (critical, high, moderate, low)'
        type: string
        default: 'moderate'
        required: false
      
      deny-licenses:
        description: 'Comma-separated list of licenses to deny (e.g., GPL-3.0,AGPL-3.0)'
        type: string
        default: ''
        required: false
      
      comment-summary-in-pr:
        description: 'Post a comment with the summary in the PR'
        type: boolean
        default: true
        required: false

permissions:
  contents: read

jobs:
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      issues: ${{ inputs.comment-summary-in-pr && 'write' || 'read' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1
        with:
          persist-credentials: false
      
      - name: Run Dependency Review
        uses: actions/dependency-review-action@5a2ce3f5b92ee19cbb1541a4984c76d921601d7c  # v4.3.4
        with:
          fail-on-severity: ${{ inputs.fail-on-severity }}
          deny-licenses: ${{ inputs.deny-licenses }}
          comment-summary-in-pr: ${{ inputs.comment-summary-in-pr }}
          
          # Additional security configurations
          vulnerability-check: true
          license-check: true
          
          # Retry configuration for API rate limits
          retry-on-snapshot-warnings: true
          retry-on-snapshot-warnings-timeout: 600
