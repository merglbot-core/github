# SLSA Build Attestation Reusable Workflow
# 
# Purpose: Build container images with SLSA provenance and Binary Authorization attestation
# SLSA Level: 3 (hermetic, reproducible builds with provenance)
# 
# Usage in caller workflow:
#   jobs:
#     build:
#       uses: merglbot-github-workflows/.github/workflows/reusable-build-attest.yml@main
#       with:
#         image_name: website
#         dockerfile: ./Dockerfile
#         context: .
#       secrets:
#         wif_provider: ${{ secrets.GCP_WIF_PROVIDER }}
#         wif_service_account: ${{ secrets.GCP_WIF_SERVICE_ACCOUNT }}
#
# Reference: https://slsa.dev/
#
# Note: Trivy scan is integrated into the build job per policy requirements
# (Trivy scan must be in the same job as Docker build)

name: Reusable Build with SLSA Attestation

on:
  workflow_call:
    inputs:
      image_name:
        description: 'Name of the container image (without registry prefix)'
        required: true
        type: string
      dockerfile:
        description: 'Path to Dockerfile'
        required: false
        type: string
        default: './Dockerfile'
      context:
        description: 'Docker build context'
        required: false
        type: string
        default: '.'
      registry:
        description: 'Container registry'
        required: false
        type: string
        default: 'europe-west1-docker.pkg.dev/merglbot-artifacts/images'
      push:
        description: 'Push image to registry'
        required: false
        type: boolean
        default: true
      attest:
        description: 'Create Binary Authorization attestation'
        required: false
        type: boolean
        default: true
      scan:
        description: 'Run Trivy vulnerability scan'
        required: false
        type: boolean
        default: true
    secrets:
      wif_provider:
        description: 'GCP Workload Identity Federation Provider'
        required: true
      wif_service_account:
        description: 'GCP Service Account for WIF'
        required: true
    outputs:
      image_digest:
        description: 'Full image digest (registry/image@sha256:...)'
        value: ${{ jobs.build.outputs.digest }}
      image_tag:
        description: 'Image tag'
        value: ${{ jobs.build.outputs.tag }}
      attestation_id:
        description: 'Binary Authorization attestation ID'
        value: ${{ jobs.attest.outputs.attestation_id }}
      slsa_provenance:
        description: 'SLSA provenance JSON'
        value: ${{ jobs.build.outputs.provenance }}
      scan_passed:
        description: 'Whether vulnerability scan passed'
        value: ${{ jobs.build.outputs.scan_passed }}

permissions:
  contents: read
  packages: write
  id-token: write
  security-events: write

jobs:
  build:
    name: Build, Scan & Push Image
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      digest: ${{ steps.build.outputs.digest }}
      tag: ${{ steps.meta.outputs.version }}
      provenance: ${{ steps.provenance.outputs.provenance }}
      scan_passed: ${{ steps.trivy.outcome == 'success' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Validate WIF provider (SSOT)
        shell: bash
        run: |
          set -euo pipefail

          SSOT_WIF_PROVIDER="projects/671585034644/locations/global/workloadIdentityPools/github-actions/providers/github-oidc"

          if [ "${{ secrets.wif_provider }}" != "${SSOT_WIF_PROVIDER}" ]; then
            echo "::error::wif_provider must point to the SSOT provider in merglbot-seed (${SSOT_WIF_PROVIDER})."
            exit 1
          fi

          if [[ "${{ secrets.wif_service_account }}" == *@merglbot.iam.gserviceaccount.com ]]; then
            echo "::error::wif_service_account points to a legacy service account in the DELETE_REQUESTED 'merglbot' project."
            exit 1
          fi

      - name: Authenticate to GCP
        id: auth
        uses: google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093 # v3.0.0
        with:
          workload_identity_provider: ${{ secrets.wif_provider }}
          service_account: ${{ secrets.wif_service_account }}
          token_format: 'access_token'

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker europe-west1-docker.pkg.dev --quiet

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
        with:
          images: ${{ inputs.registry }}/${{ inputs.image_name }}
          tags: |
            type=sha,prefix=,format=short
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1

      - name: Build and push image
        id: build
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: ${{ inputs.context }}
          file: ${{ inputs.dockerfile }}
          push: ${{ inputs.push }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: true
          sbom: true

      # Trivy vulnerability scan - integrated into build job per policy requirements
      - name: Run Trivy vulnerability scan
        id: trivy
        if: inputs.scan
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # v0.33.1
        with:
          image-ref: '${{ inputs.registry }}/${{ inputs.image_name }}@${{ steps.build.outputs.digest }}'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

      - name: Upload Trivy SARIF
        if: inputs.scan && always()
        uses: github/codeql-action/upload-sarif@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4.31.9
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Generate SLSA Provenance
        id: provenance
        run: |
          # Create SLSA provenance document
          PROVENANCE=$(cat <<EOF
          {
            "_type": "https://in-toto.io/Statement/v0.1",
            "predicateType": "https://slsa.dev/provenance/v0.2",
            "subject": [
              {
                "name": "${{ inputs.registry }}/${{ inputs.image_name }}",
                "digest": {
                  "sha256": "${{ steps.build.outputs.digest }}"
                }
              }
            ],
            "predicate": {
              "builder": {
                "id": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              },
              "buildType": "https://github.com/slsa-framework/slsa-github-generator/container@v1",
              "invocation": {
                "configSource": {
                  "uri": "git+https://github.com/${{ github.repository }}@${{ github.ref }}",
                  "digest": {
                    "sha1": "${{ github.sha }}"
                  },
                  "entryPoint": "${{ github.workflow }}"
                },
                "parameters": {},
                "environment": {
                  "github_actor": "${{ github.actor }}",
                  "github_sha": "${{ github.sha }}",
                  "github_repository": "${{ github.repository }}",
                  "github_ref": "${{ github.ref }}",
                  "github_run_id": "${{ github.run_id }}"
                }
              },
              "buildConfig": {
                "dockerfile": "${{ inputs.dockerfile }}",
                "context": "${{ inputs.context }}"
              },
              "metadata": {
                "buildInvocationId": "${{ github.run_id }}-${{ github.run_attempt }}",
                "buildStartedOn": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
                "completeness": {
                  "parameters": true,
                  "environment": true,
                  "materials": true
                },
                "reproducible": false
              },
              "materials": [
                {
                  "uri": "git+https://github.com/${{ github.repository }}",
                  "digest": {
                    "sha1": "${{ github.sha }}"
                  }
                }
              ]
            }
          }
          EOF
          )
          
          echo "provenance=$PROVENANCE" >> $GITHUB_OUTPUT
          echo "$PROVENANCE" > provenance.json

      - name: Upload SLSA Provenance
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: slsa-provenance
          path: provenance.json
          retention-days: 90

  attest:
    name: Binary Authorization Attestation
    needs: build
    if: inputs.attest && inputs.push
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      attestation_id: ${{ steps.attest.outputs.attestation_id }}
    
    steps:
      - name: Validate WIF provider (SSOT)
        shell: bash
        run: |
          set -euo pipefail

          SSOT_WIF_PROVIDER="projects/671585034644/locations/global/workloadIdentityPools/github-actions/providers/github-oidc"

          if [ "${{ secrets.wif_provider }}" != "${SSOT_WIF_PROVIDER}" ]; then
            echo "::error::wif_provider must point to the SSOT provider in merglbot-seed (${SSOT_WIF_PROVIDER})."
            exit 1
          fi

          if [[ "${{ secrets.wif_service_account }}" == *@merglbot.iam.gserviceaccount.com ]]; then
            echo "::error::wif_service_account points to a legacy service account in the DELETE_REQUESTED 'merglbot' project."
            exit 1
          fi

      - name: Authenticate to GCP
        uses: google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093 # v3.0.0
        with:
          workload_identity_provider: ${{ secrets.wif_provider }}
          service_account: ${{ secrets.wif_service_account }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@aa5489c8933f4cc7a4f7d45035b3b1440c9c10db # v3.0.1

      - name: Create Binary Authorization Attestation
        id: attest
        run: |
          IMAGE_DIGEST="${{ inputs.registry }}/${{ inputs.image_name }}@${{ needs.build.outputs.digest }}"
          ATTESTOR="projects/merglbot-artifacts/attestors/merglbot-build-attestor"
          
          echo "Creating attestation for: $IMAGE_DIGEST"
          
          # Create attestation using gcloud
          gcloud container binauthz attestations sign-and-create \
            --project=merglbot-artifacts \
            --artifact-url="$IMAGE_DIGEST" \
            --attestor="$ATTESTOR" \
            --keyversion="projects/merglbot-artifacts/locations/europe-west1/keyRings/binary-auth-keyring/cryptoKeys/attestor-signing-key/cryptoKeyVersions/1"
          
          # Get attestation ID
          ATTESTATION_ID=$(gcloud container binauthz attestations list \
            --project=merglbot-artifacts \
            --attestor="$ATTESTOR" \
            --artifact-url="$IMAGE_DIGEST" \
            --format="value(name)" \
            --limit=1)
          
          echo "attestation_id=$ATTESTATION_ID" >> $GITHUB_OUTPUT
          
          echo "## Binary Authorization Attestation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Attestation Created**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** \`$IMAGE_DIGEST\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Attestor:** \`$ATTESTOR\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Attestation ID:** \`$ATTESTATION_ID\`" >> $GITHUB_STEP_SUMMARY

      - name: Verify Attestation
        run: |
          IMAGE_DIGEST="${{ inputs.registry }}/${{ inputs.image_name }}@${{ needs.build.outputs.digest }}"
          
          # Verify the attestation exists
          gcloud container binauthz attestations list \
            --project=merglbot-artifacts \
            --attestor="projects/merglbot-artifacts/attestors/merglbot-build-attestor" \
            --artifact-url="$IMAGE_DIGEST" \
            --format="table(name,resourceUri)"

  summary:
    name: Build Summary
    needs: [build, attest]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Generate Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build & Scan | ${{ needs.build.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Attest | ${{ needs.attest.result == 'success' && '✅' || (needs.attest.result == 'skipped' && '⏭️' || '❌') }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry:** \`${{ inputs.registry }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** \`${{ inputs.image_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** \`${{ needs.build.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Digest:** \`${{ needs.build.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Scan Passed:** \`${{ needs.build.outputs.scan_passed }}\`" >> $GITHUB_STEP_SUMMARY
