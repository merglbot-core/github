# Security: Gitleaks Secret Scanning
# Reusable workflow for detecting secrets in code
#
# Usage:
#   jobs:
#     gitleaks:
#       uses: merglbot-core/github/.github/workflows/security-gitleaks.yml@v2
#       with:
#         fail-on-detection: true  # Optional: fail if secrets found
#
# Purpose: Detect hardcoded secrets, API keys, tokens before they reach production
# Category: Security
# Priority: HIGH
# Status: DRAFT
# Created: 2025-11-12 (Enterprise CI Audit)

name: Security - Gitleaks

on:
  workflow_call:
    inputs:
      fail-on-detection:
        description: 'Fail the workflow if secrets are detected'
        type: boolean
        default: true
        required: false
      
      config-path:
        description: 'Path to custom gitleaks config file (optional)'
        type: string
        default: ''
        required: false

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref_name }}
  cancel-in-progress: true

jobs:
  gitleaks:
    name: Secret Scanning
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      pull-requests: write
      security-events: write
    
    steps:
      - name: Validate config path
        id: config
        shell: bash
        run: |
          set -euo pipefail
          config_path="${{ inputs.config-path }}"
          if [ -z "$config_path" ]; then
            echo "path=" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          case "$config_path" in
            /*|*../*)
              echo "Invalid config-path: $config_path. Use a repository-relative path without '..'." >&2
              exit 1
              ;;
          esac
          
          echo "path=$config_path" >> "$GITHUB_OUTPUT"
      
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1
        with:
          fetch-depth: 0  # Full history for comprehensive scanning
          persist-credentials: false
      
      - name: Detect fork permissions
        id: repo-scope
        shell: bash
        run: |
          set -euo pipefail
          from_fork=false
          if [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ github.event.pull_request.head.repo.fork }}" = "true" ]; then
            from_fork=true
          fi
          echo "from-fork=$from_fork" >> "$GITHUB_OUTPUT"
          echo "Detected from_fork=$from_fork"
      
      - name: Install Gitleaks CLI
        shell: bash
        run: |
          set -euo pipefail
          version="8.18.1"
          archive="gitleaks_${version}_linux_x64.tar.gz"
          url="https://github.com/zricethezav/gitleaks/releases/download/v${version}/${archive}"
          workdir="$(mktemp -d)"
          curl -sSL "$url" -o "${workdir}/${archive}"
          tar -xzf "${workdir}/${archive}" -C "${workdir}"
          chmod +x "${workdir}/gitleaks"
          install_dir="${HOME}/.local/bin"
          mkdir -p "${install_dir}"
          mv "${workdir}/gitleaks" "${install_dir}/gitleaks"
          echo "${install_dir}" >> "${GITHUB_PATH}"
          gitleaks version
      
      - name: Run Gitleaks
        id: scan
        env:
          FAIL_ON_DETECTION: ${{ inputs.fail-on-detection }}
          CONFIG_PATH: ${{ steps.config.outputs.path }}
        shell: bash
        run: |
          set -euo pipefail
          args=(detect --source . --redact --report-format sarif --report-path results.sarif)
          if [ -n "${CONFIG_PATH}" ]; then
            args+=("--config=${CONFIG_PATH}")
          fi
          if [ "${FAIL_ON_DETECTION}" = "true" ]; then
            args+=("--exit-code=2")
          else
            args+=("--exit-code=0")
          fi
          echo "Running: gitleaks ${args[*]}"
          set +e
          gitleaks "${args[@]}"
          status=$?
          set -e
          if [ "$status" -eq 2 ]; then
            echo "has-findings=true" >> "$GITHUB_OUTPUT"
            if [ "${FAIL_ON_DETECTION}" = "true" ]; then
              exit 2
            else
              echo "Secrets detected but fail-on-detection disabled; continuing."
            fi
          elif [ "$status" -ne 0 ]; then
            echo "Gitleaks exited with status $status"
            exit "$status"
          else
            echo "has-findings=false" >> "$GITHUB_OUTPUT"
          fi
          if [ ! -f results.sarif ]; then
            echo '{"version":"2.1.0","runs":[]}' > results.sarif
          fi
      
      - name: Upload SARIF report
        if: always() && steps.repo-scope.outputs.from-fork != 'true'
        uses: github/codeql-action/upload-sarif@eb055d739abdc2e8de2e5f4ba1a8b246daa779aa  # v3.26.0
        with:
          sarif_file: results.sarif
          category: gitleaks
      
      - name: Skip SARIF upload for forks
        if: always() && steps.repo-scope.outputs.from-fork == 'true'
        run: echo "Skipping SARIF upload because the pull request originates from a fork (insufficient token perms)."
      
      - name: Comment on PR (if secrets found)
        if: steps.scan.outputs.has-findings == 'true' && github.event.pull_request.number && steps.repo-scope.outputs.from-fork != 'true'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7.0.1
        with:
          github-token: ${{ github.token }}
          script: |
            const pullRequestNumber = context.payload.pull_request?.number;
            if (!pullRequestNumber) {
              core.warning('No pull_request context available. Skipping comment.');
              return;
            }
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pullRequestNumber,
              body: 'üîê **Gitleaks detected potential secrets in this PR!**\n\n' +
                    'Please review the workflow run and remove any hardcoded secrets.\n' +
                    'Use `${{ secrets.SECRET_NAME }}` instead of hardcoded values.\n\n' +
                    'See: https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/actions/runs/' + context.runId
            })
