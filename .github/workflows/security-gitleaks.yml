# Security: Gitleaks Secret Scanning
# Reusable workflow for detecting secrets in code
#
# Usage:
#   jobs:
#     gitleaks:
#       uses: merglbot-core/github/.github/workflows/security-gitleaks.yml@v2
#       with:
#         fail-on-detection: true  # Optional: fail if secrets found
#
# Purpose: Detect hardcoded secrets, API keys, tokens before they reach production
# Category: Security
# Priority: HIGH
# Status: DRAFT
# Created: 2025-11-12 (Enterprise CI Audit)

name: Security - Gitleaks

on:
  workflow_call:
    inputs:
      fail-on-detection:
        description: 'Fail the workflow if secrets are detected'
        type: boolean
        default: true
        required: false
      
      config-path:
        description: 'Path to custom gitleaks config file (optional)'
        type: string
        default: ''
        required: false

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref_name }}
  cancel-in-progress: true

jobs:
  gitleaks:
    name: Secret Scanning
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      pull-requests: write
      security-events: write
    
    steps:
      - name: Validate config path
        id: config
        shell: bash
        run: |
          set -euo pipefail
          config_path="${{ inputs.config-path }}"
          if [ -z "$config_path" ]; then
            echo "path=" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          case "$config_path" in
            /*|*../*)
              echo "Invalid config-path: $config_path. Use a repository-relative path without '..'." >&2
              exit 1
              ;;
          esac
          
          echo "path=$config_path" >> "$GITHUB_OUTPUT"
      
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1
        with:
          fetch-depth: 0  # Full history for comprehensive scanning
          persist-credentials: false
      
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@44c470ffc35caa8b1eb3e8012ca53c2f9bea4eb5  # v2.3.6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          config: ${{ steps.config.outputs.path }}
          fail: ${{ inputs.fail-on-detection }}
      
      - name: Upload SARIF report
        if: always()
        uses: github/codeql-action/upload-sarif@eb055d739abdc2e8de2e5f4ba1a8b246daa779aa  # v3.26.0
        with:
          sarif_file: results.sarif
          category: gitleaks
      
      - name: Comment on PR (if secrets found)
        if: failure() && github.event.pull_request.number
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7.0.1
        with:
          github-token: ${{ github.token }}
          script: |
            const pullRequestNumber = context.payload.pull_request?.number;
            if (!pullRequestNumber) {
              core.warning('No pull_request context available. Skipping comment.');
              return;
            }
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pullRequestNumber,
              body: 'üîê **Gitleaks detected potential secrets in this PR!**\n\n' +
                    'Please review the workflow run and remove any hardcoded secrets.\n' +
                    'Use `${{ secrets.SECRET_NAME }}` instead of hardcoded values.\n\n' +
                    'See: https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/actions/runs/' + context.runId
            })
