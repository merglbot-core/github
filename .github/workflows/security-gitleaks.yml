# Security: Gitleaks Secret Scanning
# Reusable workflow for detecting secrets in code
#
# Usage:
#   jobs:
#     gitleaks:
#       uses: merglbot-core/github/.github/workflows/security-gitleaks.yml@v2
#       with:
#         fail-on-detection: true  # Optional: fail if secrets found
#
# Purpose: Detect hardcoded secrets, API keys, tokens before they reach production
# Category: Security
# Priority: HIGH
# Status: DRAFT
# Created: 2025-11-12 (Enterprise CI Audit)

name: Security - Gitleaks

on:
  workflow_call:
    inputs:
      fail-on-detection:
        description: 'Fail the workflow if secrets are detected'
        type: boolean
        default: true
        required: false
      
      config-path:
        description: 'Path to custom gitleaks config file (optional)'
        type: string
        default: ''
        required: false

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref_name }}
  cancel-in-progress: true

jobs:
  gitleaks:
    name: Secret Scanning
    runs-on: ubuntu-24.04
    timeout-minutes: 20
    permissions:
      contents: read
      pull-requests: write
      security-events: write
    
    steps:
      - name: Validate config path
        id: config
        shell: bash
        run: |
          set -euo pipefail
          config_path="${{ inputs.config-path }}"
          if [ -z "$config_path" ]; then
            echo "path=" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          case "$config_path" in
            /*|*../*)
              echo "Invalid config-path: $config_path. Use a repository-relative path without '..'." >&2
              exit 1
              ;;
          esac
          
          echo "path=$config_path" >> "$GITHUB_OUTPUT"
      
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v5.0.0
        with:
          fetch-depth: 0  # Full history for comprehensive scanning
          persist-credentials: false
      
      - name: Install Gitleaks CLI
        run: |
          set -euo pipefail
          wget -q https://github.com/gitleaks/gitleaks/releases/download/v8.18.4/gitleaks_8.18.4_linux_x64.tar.gz
          tar -xzf gitleaks_8.18.4_linux_x64.tar.gz
          sudo mv gitleaks /usr/local/bin/
          gitleaks version
      
      - name: Run Gitleaks
        run: |
          set -euo pipefail
          config_arg=""
          if [ -n "${{ steps.config.outputs.path }}" ]; then
            config_arg="--config=${{ steps.config.outputs.path }}"
          fi
          
          # Run gitleaks and generate SARIF report
          if [ "${{ inputs.fail-on-detection }}" = "true" ]; then
            gitleaks detect --source=. --report-path=gitleaks-report.sarif --report-format=sarif $config_arg --verbose --no-git
          else
            gitleaks detect --source=. --report-path=gitleaks-report.sarif --report-format=sarif $config_arg --verbose --no-git || true
          fi
      
      - name: Upload SARIF report
        if: always()
        continue-on-error: true  # SARIF upload may fail in reusable workflow context due to token permissions
        uses: github/codeql-action/upload-sarif@eb055d739abdc2e8de2e5f4ba1a8b246daa779aa  # v3.26.0
        with:
          sarif_file: gitleaks-report.sarif
          category: gitleaks
          token: ${{ github.token }}
      
      - name: Comment on PR (if secrets found)
        if: failure() && github.event.pull_request.number
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd  # v8.0.0
        with:
          github-token: ${{ github.token }}
          script: |
            const pullRequestNumber = context.payload.pull_request?.number;
            if (!pullRequestNumber) {
              core.warning('No pull_request context available. Skipping comment.');
              return;
            }
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pullRequestNumber,
              body: 'üîê **Gitleaks detected potential secrets in this PR!**\n\n' +
                    'Please review the workflow run and remove any hardcoded secrets.\n' +
                    'Use `${{ secrets.SECRET_NAME }}` instead of hardcoded values.\n\n' +
                    'See: https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/actions/runs/' + context.runId
            })
