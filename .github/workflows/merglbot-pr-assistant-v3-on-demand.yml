name: Merglbot PR Assistant v3 (On-Demand Multi-Model)

on:
  issue_comment:
    types: [created]
  
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number"
        required: true
        type: string
      anthropic_model:
        description: "Anthropic model"
        required: false
        type: choice
        default: "claude-sonnet-4-5-20250929"
        options:
          - claude-sonnet-4-5-20250929
          - claude-opus-4-1-20250805
          - claude-3-5-haiku-20241022
      openai_model:
        description: "OpenAI model"
        required: false
        type: choice
        default: "gpt-5.1"
        options:
          - gpt-5.1
          - gpt-5
          - gpt-4-turbo

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: merglbot-review-${{ github.event.issue.number || github.event.inputs.pr_number }}
  cancel-in-progress: true

jobs:
  check-trigger:
    name: Check Trigger
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'issue_comment' && 
       github.event.issue.pull_request && 
       contains(github.event.comment.body, '@merglbot review')) ||
      github.event_name == 'workflow_dispatch'
    outputs:
      pr_number: ${{ steps.get_pr.outputs.pr_number }}
      should_run: ${{ steps.get_pr.outputs.should_run }}
    steps:
      - name: Get PR Number
        id: get_pr
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "pr_number=${{ github.event.inputs.pr_number }}" >> "$GITHUB_OUTPUT"
            echo "should_run=true" >> "$GITHUB_OUTPUT"
            echo "âœ… Manual trigger for PR #${{ github.event.inputs.pr_number }}"
          else
            echo "pr_number=${{ github.event.issue.number }}" >> "$GITHUB_OUTPUT"
            echo "should_run=true" >> "$GITHUB_OUTPUT"
            echo "âœ… Comment trigger for PR #${{ github.event.issue.number }}"
            echo "   Triggered by: @${{ github.event.comment.user.login }}"
          fi

  multi-model-review:
    name: Multi-Model PR Review v3
    needs: check-trigger
    if: needs.check-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    env:
      ANTHROPIC_API_VERSION: "2023-06-01"
      PR_NUMBER: ${{ needs.check-trigger.outputs.pr_number }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: React to Comment
        if: github.event_name == 'issue_comment'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/comments/${{ github.event.comment.id }}/reactions \
            -f content='+1' || true
          echo "ðŸ‘ Acknowledged comment"
      
      - name: Gather Full PR Context
        id: context
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          
          echo "========================================="
          echo "GATHERING PR CONTEXT"
          echo "========================================="
          
          PR_NUM="${{ env.PR_NUMBER }}"
          echo "ðŸ“‹ PR Number: $PR_NUM"
          
          echo "ðŸ“ Fetching PR metadata..."
          gh pr view "$PR_NUM" --json title,body,author,baseRefName,headRefName,labels,additions,deletions,changedFiles > pr_metadata.json
          
          PR_TITLE=$(jq -r '.title // "No title"' pr_metadata.json)
          PR_BODY=$(jq -r '.body // "No description"' pr_metadata.json)
          PR_AUTHOR=$(jq -r '.author.login // "unknown"' pr_metadata.json)
          PR_ADDITIONS=$(jq -r '.additions // 0' pr_metadata.json)
          PR_DELETIONS=$(jq -r '.deletions // 0' pr_metadata.json)
          PR_FILES=$(jq -r '.changedFiles // 0' pr_metadata.json)
          
          echo "   Title: $PR_TITLE"
          echo "   Author: $PR_AUTHOR"
          echo "   Changes: +$PR_ADDITIONS -$PR_DELETIONS in $PR_FILES files"
          
          echo "$PR_TITLE" > pr_title.txt
          echo "$PR_BODY" > pr_body.txt
          
          echo "ðŸ“„ Fetching PR diff..."
          gh pr diff "$PR_NUM" > pr_diff.txt
          DIFF_LINES=$(wc -l < pr_diff.txt)
          echo "   Diff: $DIFF_LINES lines"
          
          echo "ðŸ“ Getting changed files..."
          gh pr view "$PR_NUM" --json files -q '.files[].path' > changed_files.txt 2>/dev/null || echo "" > changed_files.txt
          
          echo "ðŸ’¬ Fetching PR comments..."
          gh api "repos/${{ github.repository }}/issues/$PR_NUM/comments" --paginate > issue_comments.json 2>/dev/null || echo "[]" > issue_comments.json
          
          echo "ðŸ¤– Extracting bugbot findings..."
          echo "" > bugbot_findings.txt
          
          # Extract various bot findings
          for BOT_PATTERN in "cursor" "gemini" "copilot" "coderabbit" "qodo" "pr-agent" "snyk"; do
            FINDINGS=$(jq -r --arg pat "$BOT_PATTERN" '.[] | select(.user.login | test($pat; "i")) | .body' issue_comments.json 2>/dev/null || echo "")
            if [ -n "$FINDINGS" ] && [ "$FINDINGS" != "null" ]; then
              echo "### $BOT_PATTERN Bot Findings" >> bugbot_findings.txt
              echo "$FINDINGS" >> bugbot_findings.txt
              echo "" >> bugbot_findings.txt
              echo "   âœ… Found $BOT_PATTERN findings"
            fi
          done
          
          BUGBOT_SIZE=$(wc -c < bugbot_findings.txt)
          if [ "$BUGBOT_SIZE" -lt 10 ]; then
            echo "No automated bot findings detected." > bugbot_findings.txt
          fi
          
          echo "========================================="
          echo "CONTEXT GATHERING COMPLETE"
          echo "========================================="
      
      - name: Step 1 - Parallel API Calls
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_MODEL: ${{ github.event.inputs.anthropic_model || 'claude-sonnet-4-5-20250929' }}
          OPENAI_MODEL: ${{ github.event.inputs.openai_model || 'gpt-5.1' }}
        run: |
          set -euo pipefail
          
          echo "========================================="
          echo "STEP 1: PARALLEL AI ANALYSIS"
          echo "========================================="
          
          PR_TITLE=$(cat pr_title.txt)
          PR_BODY=$(cat pr_body.txt | head -c 5000)
          PR_DIFF=$(cat pr_diff.txt | head -c 45000)
          CHANGED_FILES=$(cat changed_files.txt | head -30 | tr '\n' ', ')
          BUGBOT_FINDINGS=$(cat bugbot_findings.txt | head -c 15000)
          
          # Build prompt using printf for YAML safety
          PROMPT_HEADER="# Merglbot Multi-Model Code Review v3
          
          You are a senior code reviewer for Merglbot - a platform for AI-powered code intelligence.
          
          ## Your Mission
          Perform a thorough, professional code review that:
          1. Focuses on what matters - security, bugs, architecture
          2. Respects the PRs stated goal - dont suggest unrelated changes
          3. Leverages existing bot findings - validate/filter/prioritize them
          4. Follows Merglbot standards - WARP rules, security-first, OIDC/WIF
          
          ## Context Rules
          - Language: Czech for explanations, English for code comments
          - Output Structure: Sumar (3-5 lines), Findings (prioritized), Zaver
          - Severity Levels: Critical, High, Medium, Low
          - Be Concise: No filler, only actionable insights
          
          ## Merglbot Platform Rules (MUST FOLLOW)
          - Security: No hardcoded secrets, prefer WIF/OIDC over SA JSON
          - PR Hygiene: <400 lines, conventional commits (feat/fix/docs/ci), squash merge
          - CI: Idempotent steps, no Trivy/CodeQL gate softening, SHA-pinned actions
          - WARP: Plan-Act-Verify workflow, double-confirm destructive actions
          
          ---
          
          ## PR Information
          
          **Title**: $PR_TITLE
          **PR Number**: #${{ env.PR_NUMBER }}
          **Changed Files**: $CHANGED_FILES
          
          ### PR Description (Authors Intent)
          \`\`\`
          $PR_BODY
          \`\`\`
          
          ---
          
          ## Existing Bot Findings
          
          The following findings were reported by other automated tools.
          Your job: Validate these findings, filter out false positives, and prioritize whats actually important.
          
          $BUGBOT_FINDINGS
          
          ---
          
          ## PR Diff (Code Changes)
          
          \`\`\`diff
          $PR_DIFF
          \`\`\`
          
          ---
          
          ## Your Task
          
          1. Analyze the diff against Merglbot platform standards
          2. Validate bugbot findings - which are real issues? which are noise?
          3. Find NEW issues the bots might have missed (security, edge cases, race conditions)
          4. Respect PR scope - only flag issues relevant to this PRs goal
          5. Output structured review in Czech with prioritized findings
          
          IMPORTANT: Focus on substance over quantity. A PR with no real issues should get approved quickly."
          
          echo "$PROMPT_HEADER" > /tmp/full_prompt.txt
          FULL_PROMPT=$(cat /tmp/full_prompt.txt)
          PROMPT_SIZE=$(echo "$FULL_PROMPT" | wc -c)
          echo "ðŸ“ Prompt size: $PROMPT_SIZE chars"
          
          # === ANTHROPIC CALL ===
          echo "ðŸ”µ Calling Anthropic ($ANTHROPIC_MODEL)..."
          
          jq -n \
            --arg model "$ANTHROPIC_MODEL" \
            --arg prompt "$FULL_PROMPT" \
            '{
              model: $model,
              max_tokens: 6000,
              temperature: 0.2,
              messages: [{role: "user", content: $prompt}]
            }' > /tmp/anthropic_payload.json
          
          ANTHROPIC_RESP=$(curl -s https://api.anthropic.com/v1/messages \
            -H "content-type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: $ANTHROPIC_API_VERSION" \
            -d @/tmp/anthropic_payload.json)
          
          echo "ðŸ“Š Anthropic Response: $(echo "$ANTHROPIC_RESP" | wc -c) chars"
          
          if echo "$ANTHROPIC_RESP" | jq -e ".error" > /dev/null 2>&1; then
            echo "   âŒ ERROR: $(echo "$ANTHROPIC_RESP" | jq -r '.error.message')"
            echo "API_ERROR" > anthropic_review.txt
          else
            echo "   âœ… Success"
            ANTHROPIC_CONTENT=$(echo "$ANTHROPIC_RESP" | jq -r '.content[0].text // "EMPTY"')
            echo "   Words: $(echo "$ANTHROPIC_CONTENT" | wc -w)"
            echo "$ANTHROPIC_CONTENT" > anthropic_review.txt
          fi
          
          # === OPENAI CALL ===
          echo "ðŸŸ¢ Calling OpenAI ($OPENAI_MODEL)..."
          
          jq -n \
            --arg model "$OPENAI_MODEL" \
            --arg prompt "$FULL_PROMPT" \
            '{
              model: $model,
              messages: [{role: "user", content: $prompt}],
              max_completion_tokens: 16000,
              reasoning_effort: "high"
            }' > /tmp/openai_payload.json
          
          OPENAI_RESP=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d @/tmp/openai_payload.json)
          
          echo "ðŸ“Š OpenAI Response: $(echo "$OPENAI_RESP" | wc -c) chars"
          
          if echo "$OPENAI_RESP" | jq -e ".error" > /dev/null 2>&1; then
            echo "   âŒ ERROR: $(echo "$OPENAI_RESP" | jq -r '.error.message')"
            echo "API_ERROR" > openai_review.txt
          else
            echo "   âœ… Success"
            CONTENT=$(echo "$OPENAI_RESP" | jq -r '.choices[0].message.content // empty')
            if [ -z "$CONTENT" ] || [ "$CONTENT" = "null" ]; then
              CONTENT="EMPTY"
            fi
            echo "   Words: $(echo "$CONTENT" | wc -w)"
            echo "$CONTENT" > openai_review.txt
          fi
          
          echo "========================================="
          echo "STEP 1 COMPLETE"
          echo "========================================="
      
      - name: Step 2 - Intelligent Synthesis
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ github.event.inputs.openai_model || 'gpt-5.1' }}
          ANTHROPIC_MODEL: ${{ github.event.inputs.anthropic_model || 'claude-sonnet-4-5-20250929' }}
        run: |
          set -euo pipefail
          
          echo "========================================="
          echo "STEP 2: INTELLIGENT SYNTHESIS"
          echo "========================================="
          
          ANTHROPIC_REVIEW=$(cat anthropic_review.txt)
          OPENAI_REVIEW=$(cat openai_review.txt)
          PR_TITLE=$(cat pr_title.txt)
          PR_BODY=$(cat pr_body.txt | head -c 2000)
          
          echo "ðŸ“‹ Input Reviews:"
          echo "   Anthropic: $(echo "$ANTHROPIC_REVIEW" | wc -w) words"
          echo "   OpenAI: $(echo "$OPENAI_REVIEW" | wc -w) words"
          
          SYNTHESIS_PROMPT="# Final Review Synthesis Task
          
          You are synthesizing two independent AI code reviews into ONE final, high-quality review.
          
          ## Synthesis Rules
          1. Eliminate Duplicates: If both reviews mention the same issue, keep the better explanation
          2. Prioritize by Impact: Security > Bugs > Architecture > Style
          3. Filter False Positives: Remove findings that dont apply to this PRs actual changes
          4. Respect PR Scope: Dont include suggestions unrelated to the PRs stated goal
          5. Be Decisive: End with clear APPROVE or CHANGES NEEDED verdict
          
          ## Output Format (STRICT)
          
          # Code Review Sumar
          [3-5 sentences: What this PR does, overall quality assessment, key concerns if any]
          
          ---
          
          ## Findings
          
          ### Critical (Must Fix)
          [List critical issues or None]
          
          ### High Priority
          [List high priority issues or None]
          
          ### Medium Priority
          [List medium priority issues or None]
          
          ### Low Priority / Suggestions
          [List low priority items or None]
          
          ---
          
          ## Whats Good
          [2-3 positive aspects of the PR]
          
          ---
          
          ## Zaver
          
          **Verdict**: [APPROVE or CHANGES NEEDED]
          [1-2 sentences explaining the verdict and next steps]
          
          ## IMPORTANT
          - Output ONLY the review content above
          - DO NOT add any Review Models section - thats added automatically
          - Use Czech for text, English for code terms
          - Be concise but thorough
          
          ---
          
          ## PR Context
          
          **Title**: $PR_TITLE
          **Description**: $PR_BODY
          
          ---
          
          ## Review from Anthropic ($ANTHROPIC_MODEL)
          
          $ANTHROPIC_REVIEW
          
          ---
          
          ## Review from OpenAI ($OPENAI_MODEL with HIGH reasoning)
          
          $OPENAI_REVIEW
          
          ---
          
          Now synthesize these into the FINAL review following the format above."
          
          jq -n \
            --arg model "$OPENAI_MODEL" \
            --arg prompt "$SYNTHESIS_PROMPT" \
            '{
              model: $model,
              messages: [
                {role: "system", content: "You are an expert code reviewer that synthesizes multiple AI reviews into one authoritative, well-structured final review."},
                {role: "user", content: $prompt}
              ],
              max_completion_tokens: 12000,
              reasoning_effort: "high"
            }' > /tmp/synthesis_payload.json
          
          echo "ðŸŸ¢ Calling OpenAI for synthesis ($OPENAI_MODEL)..."
          
          SYNTHESIS_RESP=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d @/tmp/synthesis_payload.json)
          
          echo "ðŸ“Š Synthesis Response: $(echo "$SYNTHESIS_RESP" | wc -c) chars"
          
          if echo "$SYNTHESIS_RESP" | jq -e ".error" > /dev/null 2>&1; then
            echo "   âŒ ERROR: $(echo "$SYNTHESIS_RESP" | jq -r '.error.message')"
            cp anthropic_review.txt final_review.txt
          else
            echo "   âœ… Success"
            CONTENT=$(echo "$SYNTHESIS_RESP" | jq -r '.choices[0].message.content // empty')
            if [ -z "$CONTENT" ] || [ "$CONTENT" = "null" ]; then
              cp anthropic_review.txt final_review.txt
            else
              echo "   Words: $(echo "$CONTENT" | wc -w)"
              echo "$CONTENT" > final_review.txt
            fi
          fi
          
          # Quality Check
          FINAL_CONTENT=$(cat final_review.txt)
          WORD_COUNT=$(echo "$FINAL_CONTENT" | wc -w)
          echo "ðŸ“Š Quality: $WORD_COUNT words"
          
          echo "========================================="
          echo "STEP 2 COMPLETE"
          echo "========================================="
      
      - name: Post Review Comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_MODEL: ${{ github.event.inputs.anthropic_model || 'claude-sonnet-4-5-20250929' }}
          OPENAI_MODEL: ${{ github.event.inputs.openai_model || 'gpt-5.1' }}
        run: |
          set -euo pipefail
          
          PR_NUM="${{ env.PR_NUMBER }}"
          
          if [ ! -s final_review.txt ] || grep -q "^API_ERROR$" final_review.txt; then
            {
              echo "## ðŸ¤– Merglbot PR Assistant v3"
              echo ""
              echo "âŒ Review generation failed. Please check workflow logs."
              echo ""
              echo "Triggered by: \`@merglbot review\`"
            } > comment.md
          else
            {
              echo "## ðŸ¤– Merglbot PR Assistant v3"
              echo ""
              cat final_review.txt
              echo ""
              echo "---"
              echo ""
              echo "<details>"
              echo "<summary>ðŸ¤– Review Models & Configuration</summary>"
              echo ""
              echo "| Phase | Model | Config |"
              echo "|-------|-------|--------|"
              echo "| Primary Analysis | Anthropic \`$ANTHROPIC_MODEL\` | temp=0.2 |"
              echo "| Secondary Analysis | OpenAI \`$OPENAI_MODEL\` | reasoning=HIGH ðŸ§  |"
              echo "| Final Synthesis | OpenAI \`$OPENAI_MODEL\` | reasoning=HIGH ðŸ§  |"
              echo ""
              echo "**Context Used**: PR Description, Full Diff, Bot Findings, Platform Rules"
              echo ""
              echo "**Triggered by**: \`@merglbot review\` command"
              echo ""
              echo "</details>"
              echo ""
              echo "---"
              echo ""
              echo "*Multi-model AI review. Validate findings before applying.*"
            } > comment.md
          fi
          
          gh pr comment "$PR_NUM" --body-file comment.md
          echo "âœ… Review posted to PR #$PR_NUM"
      
      - name: Workflow Summary
        run: |
          {
            echo "## ðŸ¤– Merglbot PR Assistant v3"
            echo ""
            echo "- **PR**: #${{ env.PR_NUMBER }}"
            echo "- **Trigger**: ${{ github.event_name == 'issue_comment' && '@merglbot review' || 'Manual dispatch' }}"
            echo "- **Timestamp**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "- **Status**: $([ -s final_review.txt ] && echo 'âœ… Success' || echo 'âŒ Failed')"
            echo ""
            echo "### Review Stats"
            echo "- Anthropic: $(cat anthropic_review.txt 2>/dev/null | wc -w || echo 0) words"
            echo "- OpenAI: $(cat openai_review.txt 2>/dev/null | wc -w || echo 0) words"
            echo "- Final: $(cat final_review.txt 2>/dev/null | wc -w || echo 0) words"
          } >> "$GITHUB_STEP_SUMMARY"
