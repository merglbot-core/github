# CI: Python
# Reusable workflow for Python projects (CI: lint, test)
#
# Usage:
#   jobs:
#     ci:
#       uses: merglbot-core/github/.github/workflows/ci-python.yml@v2
#       with:
#         python-version: '3.11'
#
# Purpose: Standardize Python CI (denatura-btf-data, future projects)
# Category: CI
# Priority: MEDIUM
# Status: PRODUCTION
# Created: 2025-11-12 (Enterprise CI Audit)

name: CI - Python

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version to use'
        type: string
        default: '3.11'
        required: false
      
      requirements-file:
        description: 'Requirements file path'
        type: string
        default: 'requirements.txt'
        required: false
      
      test-command:
        description: 'Test command (default: pytest)'
        type: string
        default: 'pytest'
        required: false
      
      lint-tools:
        description: 'Comma-separated list of linters (ruff,black,mypy)'
        type: string
        default: 'ruff,black'
        required: false
      
      working-directory:
        description: 'Working directory for commands'
        type: string
        default: '.'
        required: false

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref_name }}
  cancel-in-progress: true

jobs:
  ci:
    name: Python CI
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v5.0.0
        with:
          persist-credentials: false
      
      - name: Setup Python
        uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c  # v5.0.0
        with:
          python-version: ${{ inputs.python-version }}
          cache: 'pip'
          cache-dependency-path: ${{ inputs.working-directory }}/${{ inputs.requirements-file }}
      
      - name: Install dependencies
        working-directory: ${{ inputs.working-directory }}
        run: |
          python -m pip install --upgrade pip
          pip install -r ${{ inputs.requirements-file }}
      
      - name: Install dev dependencies
        working-directory: ${{ inputs.working-directory }}
        run: |
          if [ -f requirements-dev.txt ]; then
            pip install -r requirements-dev.txt
          fi
          # Install linters based on inputs
          if [[ "${{ inputs.lint-tools }}" == *"ruff"* ]]; then
            pip install ruff
          fi
          if [[ "${{ inputs.lint-tools }}" == *"black"* ]]; then
            pip install black
          fi
          if [[ "${{ inputs.lint-tools }}" == *"mypy"* ]]; then
            pip install mypy
          fi
      
      - name: Run ruff
        if: contains(inputs.lint-tools, 'ruff')
        working-directory: ${{ inputs.working-directory }}
        run: ruff check .
      
      - name: Run black
        if: contains(inputs.lint-tools, 'black')
        working-directory: ${{ inputs.working-directory }}
        run: black --check .
      
      - name: Run mypy
        if: contains(inputs.lint-tools, 'mypy')
        working-directory: ${{ inputs.working-directory }}
        run: mypy .
      
      - name: Run tests
        if: inputs.test-command != ''
        working-directory: ${{ inputs.working-directory }}
        run: ${{ inputs.test-command }}
        env:
          PYTHONPATH: ${{ inputs.working-directory }}
