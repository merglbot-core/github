# Utility: PR Checks
# Reusable workflow for common PR validation
#
# Usage:
#   jobs:
#     pr-checks:
#       uses: merglbot-core/github/.github/workflows/utility-pr-checks.yml@v2
#
# Purpose: Enforce PR hygiene (conventional commits, size, branch naming)
# Category: Utility
# Priority: LOW
# Status: PRODUCTION
# Created: 2025-11-12 (Enterprise CI Audit)

name: Utility - PR Checks

on:
  workflow_call:
    inputs:
      max-pr-size:
        description: 'Maximum PR size in lines of code (0 to disable)'
        type: number
        default: 400
        required: false
      
      enforce-conventional-commits:
        description: 'Enforce conventional commit format in PR title'
        type: boolean
        default: true
        required: false
      
      allowed-branch-prefixes:
        description: 'Comma-separated allowed branch prefixes (feat/,fix/,docs/,ci/)'
        type: string
        default: 'feat/,fix/,docs/,ci/,chore/,refactor/'
        required: false

permissions:
  contents: read
  pull-requests: write

jobs:
  pr-checks:
    name: PR Checks
    runs-on: ubuntu-24.04
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Check PR title (Conventional Commits)
        if: inputs.enforce-conventional-commits
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const title = context.payload.pull_request.title;
            const pattern = /^(feat|fix|docs|style|refactor|perf|test|chore|ci|build|revert)(\(.+\))?!?: .+/;
            
            if (!pattern.test(title)) {
              core.setFailed(
                `PR title "${title}" doesn't follow Conventional Commits format.\n` +
                `Expected: type(scope)?: description\n` +
                `Examples: feat: add login, fix(api): resolve timeout, docs: update README`
              );
            } else {
              console.log(`‚úÖ PR title follows Conventional Commits format`);
            }
      
      - name: Check branch naming
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branch = context.payload.pull_request.head.ref;
            const allowedPrefixes = '${{ inputs.allowed-branch-prefixes }}'.split(',');
            
            const isValid = allowedPrefixes.some(prefix => branch.startsWith(prefix.trim()));
            
            if (!isValid) {
              core.warning(
                `Branch "${branch}" doesn't follow naming convention.\n` +
                `Recommended prefixes: ${allowedPrefixes.join(', ')}`
              );
            } else {
              console.log(`‚úÖ Branch name follows convention`);
            }
      
      - name: Check PR size
        if: inputs.max-pr-size > 0
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const additions = pr.additions || 0;
            const deletions = pr.deletions || 0;
            const totalChanges = additions + deletions;
            const maxSize = ${{ inputs.max-pr-size }};
            
            console.log(`üìä PR size: +${additions} -${deletions} (total: ${totalChanges} LOC)`);
            
            if (totalChanges > maxSize) {
              core.warning(
                `‚ö†Ô∏è Large PR detected: ${totalChanges} LOC (limit: ${maxSize}).\n` +
                `Consider splitting into smaller PRs for easier review.`
              );
            } else {
              console.log(`‚úÖ PR size OK (${totalChanges}/${maxSize} LOC)`);
            }
      
      - name: Check for merge commits
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: commits } = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });
            
            const mergeCommits = commits.filter(commit => commit.parents.length > 1);
            
            if (mergeCommits.length > 0) {
              core.warning(
                `‚ö†Ô∏è Found ${mergeCommits.length} merge commit(s) in PR.\n` +
                `Use rebase or squash merge to maintain linear history.`
              );
            } else {
              console.log(`‚úÖ No merge commits found`);
            }

