name: Forecast D-1 Readiness Guardrail (08:00/10:00/15:00 Europe/Prague)

on:
  schedule:
    # GitHub cron is UTC. To keep 08:00/10:00/15:00 Europe/Prague stable across DST, we schedule both
    # CET and CEST equivalents and let the script auto-noop outside the local window.
    #
    # 08:00 Europe/Prague:
    # - CET  (UTC+1): 07:00 UTC
    # - CEST (UTC+2): 06:00 UTC
    - cron: "0 7 * * *"
    - cron: "0 6 * * *"
    #
    # 10:00 Europe/Prague:
    # - CET  (UTC+1): 09:00 UTC
    # - CEST (UTC+2): 08:00 UTC
    - cron: "0 9 * * *"
    - cron: "0 8 * * *"
    #
    # 15:00 Europe/Prague:
    # - CET  (UTC+1): 14:00 UTC
    # - CEST (UTC+2): 13:00 UTC
    - cron: "0 14 * * *"
    - cron: "0 13 * * *"

  workflow_dispatch:
    inputs:
      patch_date_local:
        description: "Date to check (YYYY-MM-DD, Europe/Prague). Default: yesterday."
        required: false
        type: string
      dry_run:
        description: "Skip Slack notifications"
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  id-token: write  # For WIF/OIDC

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  run:
    name: Forecast D-1 readiness
    runs-on: ubuntu-latest
    timeout-minutes: 25
    env:
      PYTHONUNBUFFERED: "1"

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Setup Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v6.2.0
        with:
          python-version: "3.11"

      - name: Authenticate to GCP via WIF (and install gcloud/bq/gsutil)
        uses: ./.github/actions/setup-gcp-auth
        with:
          workload_identity_provider: ${{ vars.GCP_WIF_PROVIDER }}
          service_account: ${{ vars.GCP_WIF_SERVICE_ACCOUNT }}

      - name: Run forecast D-1 readiness
        id: guardrail
        continue-on-error: true
        env:
          PATCH_DATE_LOCAL: ${{ inputs.patch_date_local }}
          MODE: ${{ github.event_name == 'workflow_dispatch' && 'manual' || 'auto' }}
          GITHUB_EVENT_SCHEDULE: ${{ github.event.schedule }}
        run: |
          set -euo pipefail
          OUTDIR="forecast-d1-readiness-out"

          CMD="python scripts/guardrails/forecast_d1_readiness.py --outdir $OUTDIR --timezone Europe/Prague --mode ${MODE}"
          if [ -n "${PATCH_DATE_LOCAL}" ]; then
            CMD="$CMD --patch-date-local ${PATCH_DATE_LOCAL}"
          fi

          echo "Running: $CMD"
          EXIT=0
          $CMD || EXIT=$?

          echo "outdir=${OUTDIR}" >> "$GITHUB_OUTPUT"
          echo "exit_code=${EXIT}" >> "$GITHUB_OUTPUT"

          SUMMARY_JSON="${OUTDIR}/forecast_d1_readiness_summary.json"
          if [ -f "$SUMMARY_JSON" ]; then
            SUMMARY_JSON="$SUMMARY_JSON" python - <<'PY' >> "$GITHUB_OUTPUT"
          import json
          import os
          from pathlib import Path

          p = Path(os.environ["SUMMARY_JSON"])
          s = json.loads(p.read_text(encoding="utf-8"))

          def _v(key: str, default: str = "") -> str:
              v = s.get(key, default)
              return "" if v is None else str(v)

          print(f"status={_v('status')}")
          print(f"slot={_v('slot')}")
          print(f"patch_date_local={_v('patch_date_local')}")
          print(f"required_policy={_v('required_policy')}")
          print(f"required_failed={_v('required_failed', '0')}")
          print(f"optional_failed={_v('optional_failed', '0')}")
          print(f"required_total={_v('required_total', '0')}")
          print(f"optional_total={_v('optional_total', '0')}")
          PY
          else
            echo "status=FAIL" >> "$GITHUB_OUTPUT"
            echo "slot=" >> "$GITHUB_OUTPUT"
            echo "patch_date_local=" >> "$GITHUB_OUTPUT"
            echo "required_policy=" >> "$GITHUB_OUTPUT"
            echo "required_failed=0" >> "$GITHUB_OUTPUT"
            echo "optional_failed=0" >> "$GITHUB_OUTPUT"
            echo "required_total=0" >> "$GITHUB_OUTPUT"
            echo "optional_total=0" >> "$GITHUB_OUTPUT"
          fi

      - name: Add report to step summary
        if: always() && steps.guardrail.outputs.outdir != ''
        run: |
          MD_FILE="${{ steps.guardrail.outputs.outdir }}/forecast_d1_readiness_report.md"
          echo "## ✅ Forecast D-1 readiness" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ -f "$MD_FILE" ]; then
            head -n 200 "$MD_FILE" >> "$GITHUB_STEP_SUMMARY"
            if [ "$(wc -l < "$MD_FILE")" -gt 200 ]; then
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo "*... Report truncated. See artifacts for full report.*" >> "$GITHUB_STEP_SUMMARY"
            fi
          else
            echo "❌ No report generated." >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          echo "- Exit code: ${{ steps.guardrail.outputs.exit_code }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Status: ${{ steps.guardrail.outputs.status }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Slot: ${{ steps.guardrail.outputs.slot }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Required policy: ${{ steps.guardrail.outputs.required_policy }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Patch date (local): ${{ steps.guardrail.outputs.patch_date_local }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Required failed: ${{ steps.guardrail.outputs.required_failed }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Optional failed: ${{ steps.guardrail.outputs.optional_failed }}" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload guardrail artifacts
        if: always() && steps.guardrail.outputs.outdir != ''
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
        with:
          name: forecast-d1-readiness-${{ github.run_id }}
          path: ${{ steps.guardrail.outputs.outdir }}/
          retention-days: 90

      - name: Slack alert (PASS/FAIL)
        if: always() && steps.guardrail.outputs.status != 'NOOP' && inputs.dry_run != true
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          set -euo pipefail

          if [ -z "${SLACK_WEBHOOK_URL}" ]; then
            echo "ℹ️ SLACK_WEBHOOK_URL not configured; skipping Slack notification."
            exit 0
          fi

          OUTDIR="${{ steps.guardrail.outputs.outdir }}"
          SUMMARY_JSON="${OUTDIR}/forecast_d1_readiness_summary.json"
          REPORT_CSV="${OUTDIR}/forecast_d1_readiness_report.csv"

          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          PAYLOAD="$(
            SUMMARY_JSON="$SUMMARY_JSON" \
            REPORT_CSV="$REPORT_CSV" \
            RUN_URL="$RUN_URL" \
            GITHUB_REPOSITORY="$GITHUB_REPOSITORY" \
              python - <<'PY'
          import csv
          import json
          import os

          summary_path = os.environ.get("SUMMARY_JSON", "")
          report_csv = os.environ.get("REPORT_CSV", "")
          run_url = os.environ.get("RUN_URL", "")
          repo = os.environ.get("GITHUB_REPOSITORY", "")

          status = "?"
          slot = ""
          policy = ""
          patch_date = ""
          req_failed = "?"
          opt_failed = "?"
          req_total = "?"
          opt_total = "?"
          try:
              with open(summary_path, "r", encoding="utf-8") as f:
                  s = json.load(f)
              status = str(s.get("status", "?"))
              slot = str(s.get("slot", "") or "")
              policy = str(s.get("required_policy", "") or "")
              patch_date = str(s.get("patch_date_local", "") or "")
              req_failed = str(s.get("required_failed", "?"))
              opt_failed = str(s.get("optional_failed", "?"))
              req_total = str(s.get("required_total", "?"))
              opt_total = str(s.get("optional_total", "?"))
          except Exception:
              pass

          color = "danger"
          try:
              if status == "PASS":
                  color = "warning" if int(opt_failed or "0") > 0 else "good"
          except Exception:
              if status == "PASS":
                  color = "good"

          title = f"Forecast D-1 readiness {status}: required_fail={req_failed}/{req_total}, optional_fail={opt_failed}/{opt_total}"
          if slot:
              title += f" (slot {slot})"
          if policy:
              title += f" [{policy}]"
          if patch_date:
              title += f" for {patch_date}"

          lines: list[str] = []
          try:
              with open(report_csv, "r", encoding="utf-8", newline="") as f:
                  reader = csv.DictReader(f)
                  fails = [row for row in reader if (row.get("status") or "").strip() == "FAIL"]
              fails.sort(key=lambda r: (0 if (r.get("is_required") or "").strip() == "yes" else 1, r.get("tenant") or "", r.get("country") or ""))
              for row in fails[:10]:
                  scope = "REQ" if (row.get("is_required") or "").strip() == "yes" else "OPT"
                  tenant = (row.get("tenant") or "").strip()
                  country = (row.get("country") or "").strip()
                  project = (row.get("project_id") or "").strip()
                  table = (row.get("table_fq") or "").strip()
                  reason = (row.get("reason") or "").strip()
                  if table:
                      lines.append(f"• {scope}: {tenant}/{country} ({project}) — {reason} — {table}")
                  else:
                      lines.append(f"• {scope}: {tenant}/{country} ({project}) — {reason}")
          except Exception:
              pass

          attachment = {
              "color": color,
              "fields": [
                  {"title": "Repo", "value": repo, "short": True},
                  {"title": "Workflow Run", "value": run_url, "short": False},
              ],
          }
          if lines:
              attachment["text"] = "\n".join(lines)

          payload = {"text": title, "attachments": [attachment]}
          print(json.dumps(payload))
          PY
          )"

          curl -sS -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            --data "$PAYLOAD"

      - name: Fail workflow if guardrail failed
        if: steps.guardrail.outputs.exit_code != '0'
        run: exit 1

