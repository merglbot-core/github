name: Reusable - Deploy to Cloud Run

on:
  workflow_call:
    inputs:
      service:
        description: 'Cloud Run service name'
        required: true
        type: string
      region:
        description: 'GCP region'
        required: false
        type: string
        default: 'europe-west1'
      project_id:
        description: 'GCP Project ID'
        required: true
        type: string
      service_account:
        description: 'Email of the Cloud Run service account'
        required: true
        type: string
      environment:
        description: 'Target environment (e.g., production, staging)'
        required: false
        type: string
        default: 'production'
      dockerfile:
        description: 'Path to the Dockerfile'
        required: false
        type: string
        default: 'Dockerfile'
      env_vars:
        description: 'Comma-separated list of ENV_VAR=value'
        required: false
        type: string
      secrets:
        description: 'Newline-separated SECRET_NAME=secret-id:version'
        required: false
        type: string
      allow_unauthenticated:
        description: 'Allow unauthenticated access (use only for services behind IAP/Load Balancer with own auth)'
        required: false
        type: boolean
        default: false
    secrets:
      GCP_WIF_PROVIDER:
        required: true
      GCP_WIF_SERVICE_ACCOUNT:
        required: true
      GAR_LOCATION:
        required: true

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-${{ inputs.service }}-${{ github.ref }}
  cancel-in-progress: false

env:
  SERVICE: ${{ inputs.service }}
  REGION: ${{ inputs.region }}
  PROJECT_ID: ${{ inputs.project_id }}
  GAR_LOCATION: ${{ secrets.GAR_LOCATION }}
  ARTIFACT_REPO: docker

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Authenticate to Google Cloud (WIF)
        id: auth
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_WIF_SERVICE_ACCOUNT }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3
      
      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev
      
      - name: Build and Push Docker image
        id: build
        run: |
          set -euo pipefail
          IMAGE="${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.SERVICE }}"
          TAG="${{ github.sha }}"
          
          docker build -t "${IMAGE}:${TAG}" -f "${{ inputs.dockerfile }}" .
          # Capture the output of docker push to extract the digest
          PUSH_OUTPUT=$(docker push "${IMAGE}:${TAG}")
          DIGEST=$(echo "$PUSH_OUTPUT" | grep -Eo 'digest: sha256:[a-f0-9]+' | head -n1 | awk '{print $2}')
          
          echo "image=${IMAGE}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT
          echo "full_image=${IMAGE}@${DIGEST}" >> $GITHUB_OUTPUT
      
      # Container Security: Trivy Scanning
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.28.0
        continue-on-error: true  # Grace period: 2 weeks
        with:
          image-ref: ${{ steps.build.outputs.full_image }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'HIGH,CRITICAL'
          exit-code: '1'
      
      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
      
      # Container Security: SBOM Generation
      - name: Generate SBOM
        uses: anchore/sbom-action@v0.17.0
        with:
          image: ${{ steps.build.outputs.full_image }}
          format: 'cyclonedx-json'
          output-file: 'sbom.json'
      
      - name: Upload SBOM as artifact
        uses: actions/upload-artifact@v4
        with:
          name: 'sbom-${{ github.sha }}'
          path: 'sbom.json'
          retention-days: 90
      
      - name: Upload SBOM to release (if tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: sbom.json
      
      # Container Security: Cosign Signing
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.5.0
      
      - name: Sign container image
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign sign --yes ${{ steps.build.outputs.full_image }}
      
      - name: Deploy to Cloud Run
        id: deploy
        run: |
          set -euo pipefail
          
          # Construct gcloud command
          gcloud_cmd=(gcloud run deploy "$SERVICE"
            "--image=${{ steps.build.outputs.full_image }}"
            "--region=$REGION"
            "--project=$PROJECT_ID"
            "--service-account=${{ inputs.service_account }}"
            "--max-instances=10"
            "--min-instances=0"
            "--memory=1Gi"
            "--cpu=1"
            "--port=8080"
          )

          # Authentication flag (default: no-allow-unauthenticated for security)
          if [ "${{ inputs.allow_unauthenticated }}" = "true" ]; then
            gcloud_cmd+=("--allow-unauthenticated")
          else
            gcloud_cmd+=("--no-allow-unauthenticated")
          fi

          if [ -n "${{ inputs.env_vars }}" ]; then
            gcloud_cmd+=("--set-env-vars=${{ inputs.env_vars }}")
          fi
          
          if [ -n "${{ inputs.secrets }}" ]; then
            # Convert newline-separated to comma-separated list
            SECRET_LIST=$(echo "${{ inputs.secrets }}" | sed '/^$/d' | paste -sd, -)
            gcloud_cmd+=("--set-secrets=${SECRET_LIST}")
          fi
          
          # Execute the command
          "${gcloud_cmd[@]}"

          URL=$(gcloud run services describe "$SERVICE" --region="$REGION" --project="$PROJECT_ID" --format="value(status.url)")
          echo "url=$URL" >> $GITHUB_OUTPUT
      
      - name: Update deployment summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸš€ Reusable Deployment
          - **Service**: $SERVICE
          - **URL**: ${{ steps.deploy.outputs.url }}
          - **Status**: ${{ job.status }}
          EOF
