# CI: Terraform
# Reusable workflow for Terraform IaC validation
#
# Usage:
#   jobs:
#     terraform:
#       uses: merglbot-core/github/.github/workflows/ci-terraform.yml@v2
#       with:
#         terraform-version: '1.6'
#
# Purpose: Standardize Terraform CI (infra, tf-modules-)
# Category: CI
# Priority: MEDIUM
# Status: PRODUCTION
# Created: 2025-11-12 (Enterprise CI Audit)

name: CI - Terraform

on:
  workflow_call:
    inputs:
      terraform-version:
        description: 'Terraform version to use'
        type: string
        default: '1.6'
        required: false
      
      working-directory:
        description: 'Working directory for Terraform commands'
        type: string
        default: '.'
        required: false
      
      run-tflint:
        description: 'Run tflint'
        type: boolean
        default: true
        required: false
      
      run-checkov:
        description: 'Run checkov security scan'
        type: boolean
        default: true
        required: false
      
      run-plan:
        description: 'Run terraform plan (requires cloud credentials)'
        type: boolean
        default: false
        required: false

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref_name }}
  cancel-in-progress: true

jobs:
  terraform:
    name: Terraform CI
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
        with:
          persist-credentials: false
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd  # v3.1.2
        with:
          terraform_version: ${{ inputs.terraform-version }}
      
      - name: Terraform Format Check
        working-directory: ${{ inputs.working-directory }}
        run: terraform fmt -check -recursive
      
      - name: Terraform Init
        working-directory: ${{ inputs.working-directory }}
        env:
          TF_PLUGIN_CACHE_DIR: ${{ runner.temp }}/terraform-plugin-cache
        run: |
          mkdir -p "${TF_PLUGIN_CACHE_DIR}"
          terraform init -backend=false
      
      - name: Terraform Validate
        working-directory: ${{ inputs.working-directory }}
        run: terraform validate
      
      - name: Setup TFLint
        if: inputs.run-tflint
        uses: terraform-linters/setup-tflint@4cb9feea73331a35b422df102992a03a44a3bb33  # v6.2.1
        with:
          tflint_version: v0.51.1
      
      - name: Run TFLint
        if: inputs.run-tflint
        working-directory: ${{ inputs.working-directory }}
        run: |
          tflint --init
          tflint --format compact
      
      - name: Setup Checkov
        if: inputs.run-checkov
        run: |
          python -m pip install --upgrade pip
          pip install checkov==3.2.493
      
      - name: Run Checkov
        if: inputs.run-checkov
        working-directory: ${{ inputs.working-directory }}
        run: |
          checkov --directory . \
            --framework terraform \
            --output cli \
            --quiet \
            --compact
      
      - name: Terraform Plan
        if: inputs.run-plan
        working-directory: ${{ inputs.working-directory }}
        run: terraform plan -no-color
        continue-on-error: true
