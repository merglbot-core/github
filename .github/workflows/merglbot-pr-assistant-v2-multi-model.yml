name: Merglbot PR Assistant v2 (Multi-Model)

on:
  workflow_call:
    inputs:
      pr_number:
        description: "PR number"
        required: true
        type: string
      prompt:
        description: "Custom instruction"
        required: false
        type: string
        default: |
          ProveÄ profesionÃ¡lnÃ­ code review tohoto PR. ZamÄ›Å™ se na: (1) bezpeÄnost (secrets, OIDC/WIF), (2) architekturnÃ­ konzistenci s WARP rules, (3) potenciÃ¡lnÃ­ bugy a edge cases, (4) kvalitu kÃ³du a idiomatiÄnost. OdpovÄ›z Äesky, kÃ³d komentuj anglicky. VÃ½stup: krÃ¡tkÃ½ sumÃ¡Å™ (3-5 Å™Ã¡dkÅ¯), seznam konkrÃ©tnÃ­ch findings (kaÅ¾dÃ½ s vysvÄ›tlenÃ­m a doporuÄenÃ­m), zÃ¡vÄ›r (schvÃ¡lit/changes needed).
      anthropic_model:
        description: "Anthropic model"
        required: false
        type: string
        default: "claude-sonnet-4-5-20250929"
      openai_model:
        description: "OpenAI model"
        required: false
        type: string  
        default: "gpt-5.1"
      temperature:
        description: "Temperature"
        required: false
        type: string
        default: "0.2"
    secrets:
      ANTHROPIC_API_KEY:
        required: true
      OPENAI_API_KEY:
        required: true
      GH_TOKEN:
        required: false

  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number"
        required: true
        type: string
      anthropic_model:
        description: "Anthropic model"
        required: false
        type: choice
        default: "claude-sonnet-4-5-20250929"
        options:
          - claude-sonnet-4-5-20250929
          - claude-opus-4-1-20250805
          - claude-3-5-haiku-20241022
      openai_model:
        description: "OpenAI model"
        required: false
        type: choice
        default: "gpt-5.1"
        options:
          - gpt-5.1
          - gpt-5
          - gpt-4-turbo
          - o1-preview
          - o1-mini
          - gpt-4

permissions:
  contents: write
  pull-requests: write
  id-token: write

concurrency:
  group: pr-assistant-v2-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  multi-model-review:
    name: Multi-Model PR Review
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    env:
      ANTHROPIC_API_VERSION: "2023-06-01"
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Parse PR Number
        id: parse
        run: |
          set -euo pipefail
          
          echo "=== Parsing PR Number ==="
          PR_INPUT="${{ inputs.pr_number }}"
          
          if [[ "$PR_INPUT" =~ ^[0-9]+$ ]]; then
            PR_NUM="$PR_INPUT"
          elif [[ "$PR_INPUT" =~ /pull/([0-9]+) ]]; then
            PR_NUM="${BASH_REMATCH[1]}"
          else
            echo "Invalid PR number: $PR_INPUT"
            exit 1
          fi
          
          echo "pr_number=$PR_NUM" >> "$GITHUB_OUTPUT"
          echo "âœ… PR Number: $PR_NUM"
      
      - name: Get PR Diff
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          
          PR_NUM="${{ steps.parse.outputs.pr_number }}"
          
          echo "=== Fetching PR Diff ==="
          gh pr diff "$PR_NUM" > pr_diff.txt
          
          DIFF_SIZE=$(wc -l < pr_diff.txt)
          echo "Diff size: $DIFF_SIZE lines"
          
          if [ "$DIFF_SIZE" -eq 0 ]; then
            echo "âš ï¸ Empty diff"
            echo "# No changes" > pr_diff.txt
          fi
          
          echo "âœ… Diff fetched"
      
      - name: Step 1 - Parallel API Calls (Anthropic + OpenAI)
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_MODEL: ${{ inputs.anthropic_model || 'claude-sonnet-4-5-20250929' }}
          OPENAI_MODEL: ${{ inputs.openai_model || 'gpt-5.1' }}
          TEMPERATURE: ${{ inputs.temperature || '0.2' }}
          PROMPT: ${{ inputs.prompt }}
        run: |
          set -euo pipefail
          
          echo "========================================="
          echo "STEP 1: PARALLEL API CALLS"
          echo "========================================="
          echo ""
          
          DIFF_CONTENT=$(cat pr_diff.txt | head -c 50000)
          
          # Build full prompt in file
          echo "$PROMPT" > /tmp/full_prompt.txt
          echo "" >> /tmp/full_prompt.txt
          echo "PR Diff:" >> /tmp/full_prompt.txt
          echo '```' >> /tmp/full_prompt.txt
          echo "$DIFF_CONTENT" >> /tmp/full_prompt.txt
          echo '```' >> /tmp/full_prompt.txt
          
          FULL_PROMPT=$(cat /tmp/full_prompt.txt)
          
          # === ANTHROPIC CALL ===
          echo "ðŸ”µ Calling Anthropic ($ANTHROPIC_MODEL)..."
          echo "   API Version: $ANTHROPIC_API_VERSION"
          echo "   Temperature: $TEMPERATURE"
          echo ""
          
          jq -n \
            --arg model "$ANTHROPIC_MODEL" \
            --arg prompt "$FULL_PROMPT" \
            --arg temp "$TEMPERATURE" \
            '{
              model: $model,
              max_tokens: 4000,
              temperature: ($temp | tonumber),
              messages: [
                {role: "user", content: $prompt}
              ]
            }' > /tmp/anthropic_payload.json
          
          ANTHROPIC_RESP=$(curl -s https://api.anthropic.com/v1/messages \
            -H "content-type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: $ANTHROPIC_API_VERSION" \
            -d @/tmp/anthropic_payload.json)
          
          echo "$ANTHROPIC_RESP" > anthropic_response.json
          
          echo "ðŸ“Š Anthropic Response:"
          echo "   Length: $(echo "$ANTHROPIC_RESP" | wc -c) chars"
          
          if echo "$ANTHROPIC_RESP" | jq -e ".error" > /dev/null 2>&1; then
            echo "   âŒ ERROR: $(echo "$ANTHROPIC_RESP" | jq -r '.error.message')"
            echo "API_ERROR" > anthropic_review.txt
          else
            echo "   âœ… Success"
            echo "$ANTHROPIC_RESP" | jq -r '.content[0].text // "EMPTY"' > anthropic_review.txt
          fi
          echo ""
          
          # === OPENAI CALL ===
          echo "ðŸŸ¢ Calling OpenAI ($OPENAI_MODEL)..."
          echo "   Temperature: $TEMPERATURE"
          echo "   Reasoning Effort: HIGH"
          echo ""
          
          jq -n \
            --arg model "$OPENAI_MODEL" \
            --arg prompt "$FULL_PROMPT" \
            '{
              model: $model,
              messages: [
                {role: "user", content: $prompt}
              ],
              max_completion_tokens: 4000,
              reasoning_effort: "high"
            }' > /tmp/openai_payload.json
          
          OPENAI_RESP=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d @/tmp/openai_payload.json)
          
          echo "$OPENAI_RESP" > openai_response.json
          
          echo "ðŸ“Š OpenAI Response:"
          echo "   Length: $(echo "$OPENAI_RESP" | wc -c) chars"
          echo "   Response keys: $(echo "$OPENAI_RESP" | jq -r 'keys | join(", ")' 2>/dev/null || echo 'N/A')"
          
          if echo "$OPENAI_RESP" | jq -e ".error" > /dev/null 2>&1; then
            echo "   âŒ ERROR: $(echo "$OPENAI_RESP" | jq -r '.error.message')"
            echo "API_ERROR" > openai_review.txt
          else
            echo "   âœ… Success"
            # GPT-5.1 may have content in different places - try multiple
            CONTENT=$(echo "$OPENAI_RESP" | jq -r '.choices[0].message.content // empty')
            if [ -z "$CONTENT" ]; then
              # Try output_text for reasoning models
              CONTENT=$(echo "$OPENAI_RESP" | jq -r '.output_text // empty')
            fi
            if [ -z "$CONTENT" ]; then
              # Try output array for responses API
              CONTENT=$(echo "$OPENAI_RESP" | jq -r '.output[0].content[0].text // empty')
            fi
            if [ -z "$CONTENT" ]; then
              CONTENT="EMPTY"
            fi
            echo "   Content length: ${#CONTENT} chars"
            echo "$CONTENT" > openai_review.txt
          fi
          echo ""
          
          echo "========================================="
          echo "STEP 1 COMPLETE"
          echo "========================================="
      
      - name: Step 2 - Synthesize Final Review (OpenAI)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ inputs.openai_model || 'gpt-5.1' }}
          ANTHROPIC_MODEL: ${{ inputs.anthropic_model || 'claude-sonnet-4-5-20250929' }}
        run: |
          set -euo pipefail
          
          echo "========================================="
          echo "STEP 2: FINAL SYNTHESIS"
          echo "========================================="
          echo ""
          
          ANTHROPIC_REVIEW=$(cat anthropic_review.txt)
          OPENAI_REVIEW=$(cat openai_review.txt)
          
          echo "ðŸ“‹ Input Reviews:"
          echo "   Anthropic: $(echo "$ANTHROPIC_REVIEW" | wc -w) words"
          echo "   OpenAI: $(echo "$OPENAI_REVIEW" | wc -w) words"
          echo ""
          
          # Build synthesis prompt in file
          {
            echo "MÃ¡Å¡ k dispozici dva AI-generovanÃ© code review stejnÃ©ho PR:"
            echo ""
            echo "**Review od Anthropic ($ANTHROPIC_MODEL):**"
            echo "$ANTHROPIC_REVIEW"
            echo ""
            echo "**Review od OpenAI ($OPENAI_MODEL):**"
            echo "$OPENAI_REVIEW"
            echo ""
            echo "**TvÅ¯j Ãºkol:**"
            echo "VytvoÅ™ finÃ¡lnÃ­, komplexnÃ­ code review, kterÃ½:"
            echo "1. Zkombinuje nejlepÅ¡Ã­ insights z obou reviews"
            echo "2. OdstranÃ­ duplicity"
            echo "3. Prioritizuje findings podle severity"
            echo "4. ZachovÃ¡ strukturu: SumÃ¡Å™, Findings, ZÃ¡vÄ›r"
            echo "5. OdpovÄ›Ä v ÄeÅ¡tinÄ›, kÃ³d komentuj anglicky"
            echo ""
            echo "**DÅ®LEÅ½ITÃ‰: NIKDY nepÅ™idÃ¡vej sekci o review models na konec - to se pÅ™idÃ¡ automaticky!**"
            echo ""
            echo "ZamÄ›Å™ se pouze na code review obsah."
          } > /tmp/synthesis_prompt.txt
          
          SYNTHESIS_PROMPT=$(cat /tmp/synthesis_prompt.txt)
          
          jq -n \
            --arg model "$OPENAI_MODEL" \
            --arg prompt "$SYNTHESIS_PROMPT" \
            '{
              model: $model,
              messages: [
                {role: "system", content: "You are an expert code reviewer that synthesizes multiple AI reviews into a single comprehensive review."},
                {role: "user", content: $prompt}
              ],
              max_completion_tokens: 6000,
              reasoning_effort: "high"
            }' > /tmp/synthesis_payload.json
          
          echo "ðŸŸ¢ Calling OpenAI for synthesis ($OPENAI_MODEL)..."
          echo "   Reasoning Effort: HIGH"
          echo ""
          
          SYNTHESIS_RESP=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d @/tmp/synthesis_payload.json)
          
          echo "$SYNTHESIS_RESP" > synthesis_response.json
          
          echo "ðŸ“Š Synthesis Response:"
          echo "   Length: $(echo "$SYNTHESIS_RESP" | wc -c) chars"
          echo "   Response keys: $(echo "$SYNTHESIS_RESP" | jq -r 'keys | join(", ")' 2>/dev/null || echo 'N/A')"
          
          if echo "$SYNTHESIS_RESP" | jq -e ".error" > /dev/null 2>&1; then
            echo "   âŒ ERROR: $(echo "$SYNTHESIS_RESP" | jq -r '.error.message')"
            echo "Fallback: Using Anthropic review only"
            cp anthropic_review.txt final_review.txt
          else
            echo "   âœ… Success"
            # GPT-5.1 may have content in different places
            CONTENT=$(echo "$SYNTHESIS_RESP" | jq -r '.choices[0].message.content // empty')
            if [ -z "$CONTENT" ]; then
              CONTENT=$(echo "$SYNTHESIS_RESP" | jq -r '.output_text // empty')
            fi
            if [ -z "$CONTENT" ]; then
              CONTENT=$(echo "$SYNTHESIS_RESP" | jq -r '.output[0].content[0].text // empty')
            fi
            if [ -z "$CONTENT" ] || [ "$CONTENT" = "null" ]; then
              echo "   âš ï¸ No content found, using Anthropic fallback"
              cp anthropic_review.txt final_review.txt
            else
              echo "   Content length: ${#CONTENT} chars"
              echo "$CONTENT" > final_review.txt
            fi
          fi
          
          FINAL_SIZE=$(cat final_review.txt | wc -w)
          echo "   Final review: $FINAL_SIZE words"
          echo ""
          
          echo "========================================="
          echo "STEP 2 COMPLETE"
          echo "========================================="
      
      - name: Post PR Comment
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          ANTHROPIC_MODEL: ${{ inputs.anthropic_model || 'claude-sonnet-4-5-20250929' }}
          OPENAI_MODEL: ${{ inputs.openai_model || 'gpt-5.1' }}
        run: |
          set -euo pipefail
          
          PR_NUM="${{ steps.parse.outputs.pr_number }}"
          
          if [ ! -s final_review.txt ] || grep -q "EMPTY\|ERROR" final_review.txt; then
            {
              echo "## ðŸ¤– Merglbot PR Assistant (Multi-Model)"
              echo ""
              echo "No review generated or API error occurred."
            } > comment.md
          else
            {
              echo "## ðŸ¤– Merglbot PR Assistant (Multi-Model)"
              echo ""
              cat final_review.txt
              echo ""
              echo "---"
              echo ""
              echo "### ðŸ¤– Review Models"
              echo ""
              echo "- **Primary Analysis**: Anthropic \`$ANTHROPIC_MODEL\`"
              echo "- **Secondary Analysis**: OpenAI \`$OPENAI_MODEL\` **(reasoning_effort: HIGH ðŸ§ )**"
              echo "- **Final Synthesis**: OpenAI \`$OPENAI_MODEL\` **(reasoning_effort: HIGH ðŸ§ )**"
              echo ""
              echo "---"
              echo ""
              echo "*Multi-model AI review powered by cutting-edge reasoning. Please verify before applying.*"
            } > comment.md
          fi
          
          gh pr comment "$PR_NUM" --body-file comment.md
          
          echo "âœ… Comment posted to PR #$PR_NUM"
      
      - name: Workflow Summary
        run: |
          set -euo pipefail
          
          {
            echo "## ðŸ¤– Multi-Model PR Assistant v2"
            echo ""
            echo "- **PR**: #${{ steps.parse.outputs.pr_number }}"
            echo "- **Timestamp**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "- **Anthropic Model**: ${{ inputs.anthropic_model || 'claude-sonnet-4-5-20250929' }}"
            echo "- **OpenAI Model**: ${{ inputs.openai_model || 'gpt-5.1' }}"
            echo "- **Reasoning Effort**: HIGH ðŸ§ "
            echo "- **Status**: $([ -s final_review.txt ] && echo "âœ… Success" || echo "âŒ Failed")"
            echo ""
            echo "### Review Sizes"
            echo "- Anthropic: $(cat anthropic_review.txt | wc -w) words"
            echo "- OpenAI: $(cat openai_review.txt | wc -w) words"
            echo "- Final: $(cat final_review.txt | wc -w) words"
            echo ""
            echo "### Model Configuration"
            echo "- **Primary Analysis**: Anthropic (temperature: ${{ inputs.temperature || '0.2' }})"
            echo "- **Secondary Analysis**: OpenAI + reasoning_effort: HIGH"
            echo "- **Synthesis**: OpenAI + reasoning_effort: HIGH"
          } >> "$GITHUB_STEP_SUMMARY"

