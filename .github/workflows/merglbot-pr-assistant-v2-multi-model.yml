name: Merglbot PR Assistant v2 (Multi-Model)

on:
  workflow_call:
    inputs:
      pr_number:
        description: "PR number"
        required: true
        type: string
      prompt:
        description: "Custom instruction"
        required: false
        type: string
        default: |
          Proveƒè profesion√°ln√≠ code review tohoto PR. Zamƒõ≈ô se na: (1) bezpeƒçnost (secrets, OIDC/WIF), (2) architekturn√≠ konzistenci s WARP rules, (3) potenci√°ln√≠ bugy a edge cases, (4) kvalitu k√≥du a idiomatiƒçnost. Odpovƒõz ƒçesky, k√≥d komentuj anglicky. V√Ωstup: kr√°tk√Ω sum√°≈ô (3-5 ≈ô√°dk≈Ø), seznam konkr√©tn√≠ch findings (ka≈æd√Ω s vysvƒõtlen√≠m a doporuƒçen√≠m), z√°vƒõr (schv√°lit/changes needed).
      anthropic_model:
        description: "Anthropic model"
        required: false
        type: string
        default: "claude-sonnet-4-5-20250929"
      openai_model:
        description: "OpenAI model"
        required: false
        type: string  
        default: "gpt-5.1"
      temperature:
        description: "Temperature"
        required: false
        type: string
        default: "0.2"
    secrets:
      ANTHROPIC_API_KEY:
        required: true
      OPENAI_API_KEY:
        required: true
      GH_TOKEN:
        required: false

  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number"
        required: true
        type: string
      anthropic_model:
        description: "Anthropic model"
        required: false
        type: choice
        default: "claude-sonnet-4-5-20250929"
        options:
          - claude-sonnet-4-5-20250929
          - claude-opus-4-1-20250805
          - claude-3-5-haiku-20241022
      openai_model:
        description: "OpenAI model"
        required: false
        type: choice
        default: "gpt-5.1"
        options:
          - gpt-5.1
          - gpt-5
          - gpt-4-turbo
          - o1-preview
          - o1-mini
          - gpt-4

permissions:
  contents: write
  pull-requests: write
  id-token: write

concurrency:
  group: pr-assistant-v2-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  multi-model-review:
    name: Multi-Model PR Review
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    env:
      ANTHROPIC_API_VERSION: "2023-06-01"
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Parse PR Number
        id: parse
        run: |
          set -euo pipefail
          
          echo "=== Parsing PR Number ==="
          PR_INPUT="${{ inputs.pr_number }}"
          
          if [[ "$PR_INPUT" =~ ^[0-9]+$ ]]; then
            PR_NUM="$PR_INPUT"
          elif [[ "$PR_INPUT" =~ /pull/([0-9]+) ]]; then
            PR_NUM="${BASH_REMATCH[1]}"
          else
            echo "Invalid PR number: $PR_INPUT"
            exit 1
          fi
          
          echo "pr_number=$PR_NUM" >> "$GITHUB_OUTPUT"
          echo "‚úÖ PR Number: $PR_NUM"
      
      - name: Get PR Diff
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          
          PR_NUM="${{ steps.parse.outputs.pr_number }}"
          
          echo "=== Fetching PR Diff ==="
          gh pr diff "$PR_NUM" > pr_diff.txt
          
          DIFF_SIZE=$(wc -l < pr_diff.txt)
          echo "Diff size: $DIFF_SIZE lines"
          
          if [ "$DIFF_SIZE" -eq 0 ]; then
            echo "‚ö†Ô∏è Empty diff"
            echo "# No changes" > pr_diff.txt
          fi
          
          echo "‚úÖ Diff fetched"
      
      - name: Step 1 - Parallel API Calls (Anthropic + OpenAI)
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_MODEL: ${{ inputs.anthropic_model || 'claude-sonnet-4-5-20250929' }}
          OPENAI_MODEL: ${{ inputs.openai_model || 'gpt-5.1' }}
          TEMPERATURE: ${{ inputs.temperature || '0.2' }}
          PROMPT: ${{ inputs.prompt }}
        run: |
          set -euo pipefail
          
          echo "========================================="
          echo "STEP 1: PARALLEL API CALLS"
          echo "========================================="
          echo ""
          
          DIFF_CONTENT=$(cat pr_diff.txt | head -c 50000)
          
          # Build full prompt in file
          echo "$PROMPT" > /tmp/full_prompt.txt
          echo "" >> /tmp/full_prompt.txt
          echo "PR Diff:" >> /tmp/full_prompt.txt
          echo '```' >> /tmp/full_prompt.txt
          echo "$DIFF_CONTENT" >> /tmp/full_prompt.txt
          echo '```' >> /tmp/full_prompt.txt
          
          FULL_PROMPT=$(cat /tmp/full_prompt.txt)
          
          # === ANTHROPIC CALL ===
          echo "üîµ Calling Anthropic ($ANTHROPIC_MODEL)..."
          echo "   API Version: $ANTHROPIC_API_VERSION"
          echo "   Temperature: $TEMPERATURE"
          echo ""
          
          jq -n \
            --arg model "$ANTHROPIC_MODEL" \
            --arg prompt "$FULL_PROMPT" \
            --arg temp "$TEMPERATURE" \
            '{
              model: $model,
              max_tokens: 4000,
              temperature: ($temp | tonumber),
              messages: [
                {role: "user", content: $prompt}
              ]
            }' > /tmp/anthropic_payload.json
          
          ANTHROPIC_RESP=$(curl -s https://api.anthropic.com/v1/messages \
            -H "content-type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: $ANTHROPIC_API_VERSION" \
            -d @/tmp/anthropic_payload.json)
          
          echo "$ANTHROPIC_RESP" > anthropic_response.json
          
          echo "üìä Anthropic Response:"
          echo "   Length: $(echo "$ANTHROPIC_RESP" | wc -c) chars"
          echo ""
          echo "üì• Anthropic Full Response (first 2000 chars):"
          echo "$ANTHROPIC_RESP" | head -c 2000
          echo ""
          echo "..."
          echo ""
          
          if echo "$ANTHROPIC_RESP" | jq -e ".error" > /dev/null 2>&1; then
            echo "   ‚ùå ERROR: $(echo "$ANTHROPIC_RESP" | jq -r '.error.message')"
            echo "API_ERROR" > anthropic_review.txt
          else
            echo "   ‚úÖ Success"
            ANTHROPIC_CONTENT=$(echo "$ANTHROPIC_RESP" | jq -r '.content[0].text // "EMPTY"')
            echo "   Extracted content (first 500 chars): $(echo "$ANTHROPIC_CONTENT" | head -c 500)..."
            echo "$ANTHROPIC_CONTENT" > anthropic_review.txt
          fi
          echo ""
          
          # === OPENAI CALL (GPT-5.1 reasoning model) ===
          echo "üü¢ Calling OpenAI ($OPENAI_MODEL)..."
          echo "   Reasoning Effort: HIGH (GPT-5.1 uses default temperature=1)"
          echo ""
          echo "üìù OpenAI Prompt (first 500 chars):"
          echo "   $(echo "$FULL_PROMPT" | head -c 500)..."
          echo ""
          
          jq -n \
            --arg model "$OPENAI_MODEL" \
            --arg prompt "$FULL_PROMPT" \
            '{
              model: $model,
              messages: [
                {role: "user", content: $prompt}
              ],
              max_completion_tokens: 16000,
              reasoning_effort: "high"
            }' > /tmp/openai_payload.json
          
          echo "üì§ OpenAI Payload structure:"
          jq 'del(.messages[0].content) | . + {messages: [{role: .messages[0].role, content: "<truncated>"}]}' /tmp/openai_payload.json
          echo ""
          
          OPENAI_RESP=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d @/tmp/openai_payload.json)
          
          echo "$OPENAI_RESP" > openai_response.json
          
          echo "üìä OpenAI Response:"
          echo "   Length: $(echo "$OPENAI_RESP" | wc -c) chars"
          echo "   Response keys: $(echo "$OPENAI_RESP" | jq -r 'keys | join(", ")' 2>/dev/null || echo 'N/A')"
          echo "   Message structure: $(echo "$OPENAI_RESP" | jq -r '.choices[0].message | keys | join(", ")' 2>/dev/null || echo 'N/A')"
          echo ""
          echo "üì• OpenAI Full Response (first 2000 chars):"
          echo "$OPENAI_RESP" | head -c 2000
          echo ""
          echo "..."
          echo ""
          
          if echo "$OPENAI_RESP" | jq -e ".error" > /dev/null 2>&1; then
            echo "   ‚ùå ERROR: $(echo "$OPENAI_RESP" | jq -r '.error.message')"
            echo "API_ERROR" > openai_review.txt
          else
            echo "   ‚úÖ Success"
            
            # Debug: Show full message object (truncated)
            echo "   Full message (first 500 chars):"
            echo "$OPENAI_RESP" | jq -r '.choices[0].message | tostring' | head -c 500
            echo "..."
            echo ""
            
            # Extract content - try multiple paths
            CONTENT=$(echo "$OPENAI_RESP" | jq -r '.choices[0].message.content // empty')
            
            if [ -z "$CONTENT" ] || [ "$CONTENT" = "null" ]; then
              # Try refusal field (for safety rejections)
              CONTENT=$(echo "$OPENAI_RESP" | jq -r '.choices[0].message.refusal // empty')
            fi
            
            if [ -z "$CONTENT" ] || [ "$CONTENT" = "null" ]; then
              CONTENT="EMPTY"
            fi
            
            echo "   Extracted content length: ${#CONTENT} chars"
            echo "   Content (first 200 chars): $(echo "$CONTENT" | head -c 200)..."
            echo "$CONTENT" > openai_review.txt
            
            # Quality check
            WORD_COUNT=$(echo "$CONTENT" | wc -w)
            echo ""
            echo "üìä Quality Check:"
            echo "   Word count: $WORD_COUNT"
            
            if [ "$WORD_COUNT" -lt 100 ]; then
              echo "   ‚ö†Ô∏è WARNING: Response too short (< 100 words)"
            elif [ "$WORD_COUNT" -lt 300 ]; then
              echo "   ‚ö†Ô∏è Low quality: Response should be > 300 words"
            else
              echo "   ‚úÖ Length OK"
            fi
            
            # Check for structured content
            if echo "$CONTENT" | grep -q -i "security\|bug\|issue\|finding"; then
              echo "   ‚úÖ Contains findings keywords"
            else
              echo "   ‚ö†Ô∏è Missing expected keywords (security/bug/issue/finding)"
            fi
          fi
          echo ""
          
          echo "========================================="
          echo "STEP 1 COMPLETE"
          echo "========================================="
      
      - name: Step 2 - Synthesize Final Review (OpenAI)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ inputs.openai_model || 'gpt-5.1' }}
          ANTHROPIC_MODEL: ${{ inputs.anthropic_model || 'claude-sonnet-4-5-20250929' }}
        run: |
          set -euo pipefail
          
          echo "========================================="
          echo "STEP 2: FINAL SYNTHESIS"
          echo "========================================="
          echo ""
          
          ANTHROPIC_REVIEW=$(cat anthropic_review.txt)
          OPENAI_REVIEW=$(cat openai_review.txt)
          
          echo "üìã Input Reviews:"
          echo "   Anthropic: $(echo "$ANTHROPIC_REVIEW" | wc -w) words"
          echo "   OpenAI: $(echo "$OPENAI_REVIEW" | wc -w) words"
          echo ""
          
          # Build synthesis prompt in file
          {
            echo "M√°≈° k dispozici dva AI-generovan√© code review stejn√©ho PR:"
            echo ""
            echo "**Review od Anthropic ($ANTHROPIC_MODEL):**"
            echo "$ANTHROPIC_REVIEW"
            echo ""
            echo "**Review od OpenAI ($OPENAI_MODEL):**"
            echo "$OPENAI_REVIEW"
            echo ""
            echo "**Tv≈Øj √∫kol:**"
            echo "Vytvo≈ô fin√°ln√≠, komplexn√≠ code review, kter√Ω:"
            echo "1. Zkombinuje nejlep≈°√≠ insights z obou reviews"
            echo "2. Odstran√≠ duplicity"
            echo "3. Prioritizuje findings podle severity"
            echo "4. Zachov√° strukturu: Sum√°≈ô, Findings, Z√°vƒõr"
            echo "5. Odpovƒõƒè v ƒçe≈°tinƒõ, k√≥d komentuj anglicky"
            echo ""
            echo "**D≈ÆLE≈ΩIT√â: NIKDY nep≈ôid√°vej sekci o review models na konec - to se p≈ôid√° automaticky!**"
            echo ""
            echo "Zamƒõ≈ô se pouze na code review obsah."
          } > /tmp/synthesis_prompt.txt
          
          SYNTHESIS_PROMPT=$(cat /tmp/synthesis_prompt.txt)
          
          jq -n \
            --arg model "$OPENAI_MODEL" \
            --arg prompt "$SYNTHESIS_PROMPT" \
            '{
              model: $model,
              messages: [
                {role: "system", content: "You are an expert code reviewer that synthesizes multiple AI reviews into a single comprehensive review."},
                {role: "user", content: $prompt}
              ],
              max_completion_tokens: 10000,
              reasoning_effort: "high"
            }' > /tmp/synthesis_payload.json
          
          echo "üü¢ Calling OpenAI for synthesis ($OPENAI_MODEL)..."
          echo "   Reasoning Effort: HIGH"
          echo ""
          echo "üìù Synthesis Prompt (first 1000 chars):"
          echo "   $(echo "$SYNTHESIS_PROMPT" | head -c 1000)..."
          echo ""
          echo "üì§ Synthesis Payload structure:"
          jq 'del(.messages[].content) | . + {messages: [.messages[] | {role: .role, content: "<truncated>"}]}' /tmp/synthesis_payload.json
          echo ""
          
          SYNTHESIS_RESP=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d @/tmp/synthesis_payload.json)
          
          echo "$SYNTHESIS_RESP" > synthesis_response.json
          
          echo "üìä Synthesis Response:"
          echo "   Length: $(echo "$SYNTHESIS_RESP" | wc -c) chars"
          echo "   Response keys: $(echo "$SYNTHESIS_RESP" | jq -r 'keys | join(", ")' 2>/dev/null || echo 'N/A')"
          echo ""
          echo "üì• Synthesis Full Response (first 2000 chars):"
          echo "$SYNTHESIS_RESP" | head -c 2000
          echo ""
          echo "..."
          echo ""
          
          if echo "$SYNTHESIS_RESP" | jq -e ".error" > /dev/null 2>&1; then
            echo "   ‚ùå ERROR: $(echo "$SYNTHESIS_RESP" | jq -r '.error.message')"
            echo "Fallback: Using Anthropic review only"
            cp anthropic_review.txt final_review.txt
          else
            echo "   ‚úÖ Success"
            # GPT-5.1 may have content in different places
            CONTENT=$(echo "$SYNTHESIS_RESP" | jq -r '.choices[0].message.content // empty')
            if [ -z "$CONTENT" ]; then
              CONTENT=$(echo "$SYNTHESIS_RESP" | jq -r '.output_text // empty')
            fi
            if [ -z "$CONTENT" ]; then
              CONTENT=$(echo "$SYNTHESIS_RESP" | jq -r '.output[0].content[0].text // empty')
            fi
            if [ -z "$CONTENT" ] || [ "$CONTENT" = "null" ]; then
              echo "   ‚ö†Ô∏è No content found, using Anthropic fallback"
              cp anthropic_review.txt final_review.txt
            else
              echo "   Content length: ${#CONTENT} chars"
              echo "$CONTENT" > final_review.txt
            fi
          fi
          
          FINAL_SIZE=$(cat final_review.txt | wc -w)
          echo "   Final review: $FINAL_SIZE words"
          echo ""
          
          # Quality validation
          echo "üìä Final Review Quality Check:"
          
          FINAL_CONTENT=$(cat final_review.txt)
          
          # Check word count
          if [ "$FINAL_SIZE" -lt 500 ]; then
            echo "   ‚ö†Ô∏è WARNING: Review too short (< 500 words)"
          else
            echo "   ‚úÖ Length: $FINAL_SIZE words (good)"
          fi
          
          # Check for required sections
          if echo "$FINAL_CONTENT" | grep -q -i "sum√°≈ô\|summary"; then
            echo "   ‚úÖ Has summary section"
          else
            echo "   ‚ö†Ô∏è Missing summary section"
          fi
          
          if echo "$FINAL_CONTENT" | grep -q -i "findings\|zji≈°tƒõn√≠"; then
            echo "   ‚úÖ Has findings section"
          else
            echo "   ‚ö†Ô∏è Missing findings section"
          fi
          
          if echo "$FINAL_CONTENT" | grep -q -i "z√°vƒõr\|conclusion\|doporuƒçen√≠"; then
            echo "   ‚úÖ Has conclusion"
          else
            echo "   ‚ö†Ô∏è Missing conclusion"
          fi
          
          # Check for WARP rules references
          if echo "$FINAL_CONTENT" | grep -q "WARP"; then
            WARP_COUNT=$(echo "$FINAL_CONTENT" | grep -o "WARP" | wc -l)
            echo "   ‚úÖ WARP rules mentioned ($WARP_COUNT times)"
          else
            echo "   ‚ö†Ô∏è No WARP rules references"
          fi
          
          # Check for line numbers or code references
          if echo "$FINAL_CONTENT" | grep -q -E "line [0-9]+|≈ô√°dek [0-9]+|Lines [0-9]"; then
            echo "   ‚úÖ Contains specific line references"
          else
            echo "   ‚ö†Ô∏è Missing line number references"
          fi
          
          echo ""
          echo "========================================="
          echo "STEP 2 COMPLETE"
          echo "========================================="
      
      - name: Post PR Comment
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          ANTHROPIC_MODEL: ${{ inputs.anthropic_model || 'claude-sonnet-4-5-20250929' }}
          OPENAI_MODEL: ${{ inputs.openai_model || 'gpt-5.1' }}
        run: |
          set -euo pipefail
          
          PR_NUM="${{ steps.parse.outputs.pr_number }}"
          
          if [ ! -s final_review.txt ] || grep -q "EMPTY\|ERROR" final_review.txt; then
            {
              echo "## ü§ñ Merglbot PR Assistant (Multi-Model)"
              echo ""
              echo "No review generated or API error occurred."
            } > comment.md
          else
            {
              echo "## ü§ñ Merglbot PR Assistant (Multi-Model)"
              echo ""
              cat final_review.txt
              echo ""
              echo "---"
              echo ""
              echo "### ü§ñ Review Models"
              echo ""
              echo "- **Primary Analysis**: Anthropic \`$ANTHROPIC_MODEL\`"
              echo "- **Secondary Analysis**: OpenAI \`$OPENAI_MODEL\` **(reasoning_effort: HIGH üß†)**"
              echo "- **Final Synthesis**: OpenAI \`$OPENAI_MODEL\` **(reasoning_effort: HIGH üß†)**"
              echo ""
              echo "---"
              echo ""
              echo "*Multi-model AI review powered by cutting-edge reasoning. Please verify before applying.*"
            } > comment.md
          fi
          
          gh pr comment "$PR_NUM" --body-file comment.md
          
          echo "‚úÖ Comment posted to PR #$PR_NUM"
      
      - name: Workflow Summary
        run: |
          set -euo pipefail
          
          {
            echo "## ü§ñ Multi-Model PR Assistant v2"
            echo ""
            echo "- **PR**: #${{ steps.parse.outputs.pr_number }}"
            echo "- **Timestamp**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "- **Anthropic Model**: ${{ inputs.anthropic_model || 'claude-sonnet-4-5-20250929' }}"
            echo "- **OpenAI Model**: ${{ inputs.openai_model || 'gpt-5.1' }}"
            echo "- **Reasoning Effort**: HIGH üß†"
            echo "- **Status**: $([ -s final_review.txt ] && echo "‚úÖ Success" || echo "‚ùå Failed")"
            echo ""
            echo "### Review Sizes"
            echo "- Anthropic: $(cat anthropic_review.txt | wc -w) words"
            echo "- OpenAI: $(cat openai_review.txt | wc -w) words"
            echo "- Final: $(cat final_review.txt | wc -w) words"
            echo ""
            echo "### Model Configuration"
            echo "- **Primary Analysis**: Anthropic (temperature: ${{ inputs.temperature || '0.2' }})"
            echo "- **Secondary Analysis**: OpenAI + reasoning_effort: HIGH"
            echo "- **Synthesis**: OpenAI + reasoning_effort: HIGH"
          } >> "$GITHUB_STEP_SUMMARY"

