name: Readiness Guardrail FB Costs (Safe-Time, Europe/Prague)

on:
  schedule:
    # 07:35 UTC == 08:35 Europe/Prague in winter time (CET). Note: DST will shift this to 09:35 local.
    # Picked as max(recommended safe time) + buffer, based on measured p95 readiness.
    - cron: "35 7 * * *"
  workflow_dispatch:
    inputs:
      date_local:
        description: "Date to check (YYYY-MM-DD, Europe/Prague). Default: today in Europe/Prague."
        required: false
        type: string
      dry_run:
        description: "Skip Slack notifications"
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  id-token: write  # For WIF/OIDC

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  run:
    name: FB Cost Readiness Check
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      PYTHONUNBUFFERED: "1"

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # pinned

      - name: Setup Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v6.2.0 pinned
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: scripts/guardrails/requirements.txt

      - name: Authenticate to GCP via WIF
        uses: google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093  # pinned
        with:
          workload_identity_provider: ${{ vars.GCP_WIF_PROVIDER }}
          service_account: ${{ vars.GCP_WIF_SERVICE_ACCOUNT }}
          export_environment_variables: true

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/guardrails/requirements.txt

      - name: Run FB cost readiness guardrail
        id: guardrail
        continue-on-error: true
        env:
          DATE_LOCAL: ${{ inputs.date_local }}
        run: |
          set -euo pipefail
          OUTDIR="guardrail-out"

          cmd=(python scripts/guardrails/fb_cost_readiness_guardrail.py
               --outdir "$OUTDIR"
               --timezone "Europe/Prague"
               --mode "merged")

          if [[ -n "${DATE_LOCAL:-}" ]]; then
            if ! [[ "${DATE_LOCAL}" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
              echo "ERROR: Invalid DATE_LOCAL format (expected YYYY-MM-DD): ${DATE_LOCAL}" >&2
              exit 1
            fi
            cmd+=(--date-local "$DATE_LOCAL")
          fi

          echo "Running: ${cmd[*]}"
          EXIT=0
          "${cmd[@]}" || EXIT=$?

          echo "outdir=${OUTDIR}" >> "$GITHUB_OUTPUT"
          echo "exit_code=${EXIT}" >> "$GITHUB_OUTPUT"

      - name: Add report to step summary
        if: always()
        run: |
          MD_FILE="${{ steps.guardrail.outputs.outdir }}/fb_cost_guardrail_report.md"
          echo "## üßæ FB Cost Readiness Guardrail (safe-time, Europe/Prague)" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ -f "$MD_FILE" ]; then
            head -n 200 "$MD_FILE" >> "$GITHUB_STEP_SUMMARY"
            if [ "$(wc -l < "$MD_FILE")" -gt 200 ]; then
              echo "" >> "$GITHUB_STEP_SUMMARY"
              echo "*... Report truncated. See artifacts for full report.*" >> "$GITHUB_STEP_SUMMARY"
            fi
          else
            echo "‚ùå No report generated." >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          echo "- Exit code: ${{ steps.guardrail.outputs.exit_code }}" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload guardrail artifacts
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # pinned
        with:
          name: readiness-guardrail-fb-costs-${{ github.run_id }}
          path: ${{ steps.guardrail.outputs.outdir }}/
          retention-days: 90

      - name: Slack alert (FAIL-only)
        if: steps.guardrail.outputs.exit_code != '0' && inputs.dry_run != true
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          set -euo pipefail

          if [ -z "${SLACK_WEBHOOK_URL}" ]; then
            echo "‚ÑπÔ∏è SLACK_WEBHOOK_URL not configured; skipping Slack notification."
            exit 0
          fi

          OUTDIR="${{ steps.guardrail.outputs.outdir }}"
          SUMMARY_JSON="${OUTDIR}/fb_cost_guardrail_summary.json"
          GROUPS_CSV="${OUTDIR}/fb_cost_guardrail_groups.csv"

          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          PAYLOAD="$(
            SUMMARY_JSON="$SUMMARY_JSON" \
            GROUPS_CSV="$GROUPS_CSV" \
            RUN_URL="$RUN_URL" \
            GITHUB_REPOSITORY="$GITHUB_REPOSITORY" \
              python - <<'PY'
          import csv
          import json
          import os

          summary_path = os.environ.get("SUMMARY_JSON", "")
          groups_csv = os.environ.get("GROUPS_CSV", "")
          run_url = os.environ.get("RUN_URL", "")
          repo = os.environ.get("GITHUB_REPOSITORY", "")

          fails = "?"
          date_local = ""
          try:
              with open(summary_path, "r", encoding="utf-8") as f:
                  summary = json.load(f)
              fails = str(summary.get("groups_fail", "?"))
              date_local = str(summary.get("date_local", "") or "")
          except Exception:
              pass

          fail_lines: list[str] = []
          try:
              with open(groups_csv, "r", encoding="utf-8", newline="") as f:
                  reader = csv.DictReader(f)
                  for row in reader:
                      if row.get("status") != "FAIL":
                          continue
                      group_id = row.get("group_id") or ""
                      reason = row.get("reason") or ""
                      sla = row.get("sla_local") or ""
                      sum_spend = row.get("sum_spend") or ""
                      fail_lines.append(f"‚Ä¢ {group_id} ‚Äî {reason} (SLA {sla}, sum_spend={sum_spend})")
                      if len(fail_lines) >= 10:
                          break
          except Exception:
              pass

          text = f"üö® FB cost readiness guardrail FAIL ({fails} group(s))" + (f" for {date_local}" if date_local else "")

          attachment = {
              "color": "danger",
              "fields": [
                  {"title": "Repo", "value": repo, "short": True},
                  {"title": "Workflow Run", "value": run_url, "short": False},
              ],
          }
          if fail_lines:
              attachment["text"] = "\n".join(fail_lines)

          payload = {"text": text, "attachments": [attachment]}
          print(json.dumps(payload))
          PY
          )"

          http_code="$(
            curl -sS -o /tmp/slack_response.txt -w "%{http_code}" -X POST "$SLACK_WEBHOOK_URL" \
              -H 'Content-Type: application/json' \
              --data "$PAYLOAD" || true
          )"

          echo "Slack HTTP: $http_code"
          if [ -s /tmp/slack_response.txt ]; then
            echo "Slack response:"
            cat /tmp/slack_response.txt
          fi

      - name: Fail workflow if guardrail failed
        if: steps.guardrail.outputs.exit_code != '0'
        run: exit 1
