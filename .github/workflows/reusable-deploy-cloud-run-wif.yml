name: Deploy to Cloud Run (WIF)

on:
  workflow_call:
    inputs:
      service_name:
        description: 'Cloud Run service name'
        required: true
        type: string
      region:
        description: 'GCP region'
        required: false
        type: string
        default: 'europe-west1'
      image_name:
        description: 'Container image name (without registry prefix)'
        required: true
        type: string
      dockerfile:
        description: 'Path to Dockerfile'
        required: false
        type: string
        default: 'Dockerfile'
      environment:
        description: 'Environment (staging/production)'
        required: false
        type: string
        default: 'staging'
      min_instances:
        description: 'Minimum instances'
        required: false
        type: number
        default: 0
      max_instances:
        description: 'Maximum instances'
        required: false
        type: number
        default: 10
    secrets:
      WIF_PROVIDER:
        description: 'Workload Identity Federation provider'
        required: true
      WIF_SERVICE_ACCOUNT:
        description: 'Service account email for WIF'
        required: true
      GCP_PROJECT_ID:
        description: 'GCP Project ID'
        required: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Build, scan, and deploy usually <15m; buffer for registry latency
    permissions:
      contents: read
      id-token: write  # Required for WIF OIDC token
      security-events: write  # Needed for SARIF upload

    steps:
      - name: Checkout
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3  # v6.0.0

      - name: Authenticate to GCP (WIF)
        id: auth
        uses: google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093  # v3.0.0
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
          token_format: 'access_token'

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@aa5489c8933f4cc7a4f7d45035b3b1440c9c10db  # v3.0.1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ inputs.region }}-docker.pkg.dev --quiet

      - name: Build Container Image
        run: |
          IMAGE="${{ inputs.region }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/containers/${{ inputs.image_name }}:${{ github.sha }}"
          docker build -t $IMAGE -f ${{ inputs.dockerfile }} .
          docker push $IMAGE
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      # Container Security: Trivy scan with SARIF upload
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8  # v0.33.1
        continue-on-error: true  # Allow deploy while we tune blocking thresholds
        with:
          image-ref: ${{ env.IMAGE }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL'
          exit-code: '0'         # Do not fail deploy on scan; surfaced via SARIF
          ignore-unfixed: true

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@5d4e8d1aca955e8d8589aabd499c5cae939e33c7  # v4
        if: always()
        continue-on-error: true
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ inputs.service_name }} \
            --image ${{ env.IMAGE }} \
            --region ${{ inputs.region }} \
            --platform managed \
            --min-instances ${{ inputs.min_instances }} \
            --max-instances ${{ inputs.max_instances }} \
            --allow-unauthenticated \
            --set-env-vars="ENVIRONMENT=${{ inputs.environment }}" \
            --quiet

      - name: Get Service URL
        id: url
        run: |
          URL=$(gcloud run services describe ${{ inputs.service_name }} \
            --region ${{ inputs.region }} \
            --format 'value(status.url)')
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "üöÄ Service deployed to: $URL"

      - name: Health Check
        run: |
          echo "Performing health check..."
          for i in {1..5}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ steps.url.outputs.url }}/health" || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "‚úÖ Health check passed!"
              exit 0
            fi
            echo "Attempt $i: Status $STATUS, retrying..."
            sleep 10
          done
          echo "‚ö†Ô∏è Health check did not pass (may be expected for some services)"
