name: Merglbot Feedback Collector

# Collect feedback (reactions) on Merglbot PR review comments
# Runs weekly to aggregate feedback for prompt improvement

on:
  schedule:
    # Run every Monday at 9:00 UTC
    - cron: '0 9 * * 1'
  
  workflow_dispatch:
    inputs:
      days_back:
        description: "Days to look back for feedback"
        required: false
        default: "7"
        type: string

permissions:
  contents: write
  pull-requests: read
  issues: read

jobs:
  collect-feedback:
    name: Collect Review Feedback
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Typical run 5-10m; buffer for API pagination/rate limits
    
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
      
      - name: Collect Feedback from PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DAYS_BACK: ${{ github.event.inputs.days_back || '7' }}
        run: |
          set -euo pipefail

          if ! [[ "$DAYS_BACK" =~ ^[0-9]+$ ]]; then
            echo "Invalid DAYS_BACK: $DAYS_BACK (must be an integer)" >&2
            exit 1
          fi
          
          echo "========================================="
          echo "ðŸ“Š MERGLBOT FEEDBACK COLLECTOR"
          echo "========================================="
          echo ""
          echo "Repository: ${{ github.repository }}"
          echo "Days back: $DAYS_BACK"
          echo ""
          
          # Calculate date range
          SINCE_DATE=$(date -u -d "$DAYS_BACK days ago" '+%Y-%m-%dT00:00:00Z' 2>/dev/null || date -u -v-${DAYS_BACK}d '+%Y-%m-%dT00:00:00Z')
          echo "Collecting feedback since: $SINCE_DATE"
          echo ""
          
          # Initialize counters
          TOTAL_REVIEWS=0
          THUMBS_UP=0
          THUMBS_DOWN=0
          NO_FEEDBACK=0
          
          # Create feedback directory
          mkdir -p feedback
          
          # Get all closed and open PRs
          echo "ðŸ” Searching for Merglbot review comments..."
          
          # Search for issue comments containing Merglbot review signature
          gh api "repos/${{ github.repository }}/issues/comments" \
            --paginate \
            -f since="$SINCE_DATE" \
            -q '.[] | select(.body | contains("Merglbot PR Assistant")) | {id: .id, issue_url: .issue_url, created_at: .created_at, user: .user.login}' \
            > /tmp/merglbot_comments.json 2>/dev/null || echo "[]" > /tmp/merglbot_comments.json
          
          COMMENT_COUNT=$(cat /tmp/merglbot_comments.json | jq -s 'length')
          echo "Found $COMMENT_COUNT Merglbot review comments"
          echo ""
          
          # Process each comment
          echo "ðŸ“ˆ Collecting reactions..."
          
          cat /tmp/merglbot_comments.json | jq -c '.' | while read -r comment; do
            COMMENT_ID=$(echo "$comment" | jq -r '.id')
            CREATED_AT=$(echo "$comment" | jq -r '.created_at')
            
            # Get reactions for this comment
            REACTIONS=$(gh api "repos/${{ github.repository }}/issues/comments/$COMMENT_ID/reactions" 2>/dev/null || echo "[]")
            
            PLUS_ONE=$(echo "$REACTIONS" | jq '[.[] | select(.content == "+1")] | length')
            MINUS_ONE=$(echo "$REACTIONS" | jq '[.[] | select(.content == "-1")] | length')
            
            echo "  Comment $COMMENT_ID: ðŸ‘ $PLUS_ONE / ðŸ‘Ž $MINUS_ONE"
            
            # Save to feedback file
            echo "{\"comment_id\": $COMMENT_ID, \"created_at\": \"$CREATED_AT\", \"thumbs_up\": $PLUS_ONE, \"thumbs_down\": $MINUS_ONE}" >> feedback/reactions.jsonl
          done
          
          # Aggregate feedback
          echo ""
          echo "ðŸ“Š Aggregating feedback..."
          
          if [ -f feedback/reactions.jsonl ]; then
            TOTAL_REVIEWS=$(wc -l < feedback/reactions.jsonl)
            THUMBS_UP=$(cat feedback/reactions.jsonl | jq -s '[.[].thumbs_up] | add // 0')
            THUMBS_DOWN=$(cat feedback/reactions.jsonl | jq -s '[.[].thumbs_down] | add // 0')
            NO_FEEDBACK=$(cat feedback/reactions.jsonl | jq -s '[.[] | select(.thumbs_up == 0 and .thumbs_down == 0)] | length')
          fi
          
          # Calculate satisfaction score
          TOTAL_FEEDBACK=$((THUMBS_UP + THUMBS_DOWN))
          if [ "$TOTAL_FEEDBACK" -gt 0 ]; then
            SATISFACTION_SCORE=$(awk "BEGIN {printf \"%.1f\", $THUMBS_UP * 100 / $TOTAL_FEEDBACK}")
          else
            SATISFACTION_SCORE="N/A"
          fi
          
          echo ""
          echo "========================================="
          echo "ðŸ“Š FEEDBACK SUMMARY"
          echo "========================================="
          echo ""
          echo "Total Reviews: $TOTAL_REVIEWS"
          echo "ðŸ‘ Helpful: $THUMBS_UP"
          echo "ðŸ‘Ž Not Helpful: $THUMBS_DOWN"
          echo "No Feedback: $NO_FEEDBACK"
          echo "Satisfaction Score: $SATISFACTION_SCORE%"
          echo ""
          
          # Create summary JSON
          TIMESTAMP=$(date -u '+%Y-%m-%dT%H:%M:%SZ')
          jq -n \
            --arg timestamp "$TIMESTAMP" \
            --arg repository "${{ github.repository }}" \
            --argjson period_days "$DAYS_BACK" \
            --arg since "$SINCE_DATE" \
            --argjson total_reviews "$TOTAL_REVIEWS" \
            --argjson thumbs_up "$THUMBS_UP" \
            --argjson thumbs_down "$THUMBS_DOWN" \
            --argjson no_feedback "$NO_FEEDBACK" \
            --arg satisfaction_percent "$SATISFACTION_SCORE" \
            '{
              timestamp: $timestamp,
              repository: $repository,
              period_days: $period_days,
              since: $since,
              metrics: {
                total_reviews: $total_reviews,
                thumbs_up: $thumbs_up,
                thumbs_down: $thumbs_down,
                no_feedback: $no_feedback,
                satisfaction_percent: $satisfaction_percent
              }
            }' > feedback/summary.json
          
          echo "Summary saved to feedback/summary.json"
          cat feedback/summary.json

      - name: Collect Code Acceptance Rate
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DAYS_BACK: ${{ github.event.inputs.days_back || '7' }}
        run: |
          set -euo pipefail

          if ! [[ "$DAYS_BACK" =~ ^[0-9]+$ ]]; then
            echo "Invalid DAYS_BACK: $DAYS_BACK (must be an integer)" >&2
            exit 1
          fi

          REPO="${{ github.repository }}"
          SIGNATURE="Merglbot PR Assistant"

          mkdir -p feedback

          SINCE_DATE=$(date -u -d "$DAYS_BACK days ago" '+%Y-%m-%dT00:00:00Z' 2>/dev/null || date -u -v-${DAYS_BACK}d '+%Y-%m-%dT00:00:00Z')
          SINCE_DAY=$(date -u -d "$DAYS_BACK days ago" '+%Y-%m-%d' 2>/dev/null || date -u -v-${DAYS_BACK}d '+%Y-%m-%d')

          echo "========================================="
          echo "ðŸ“ˆ CODE ACCEPTANCE RATE (HEURISTIC)"
          echo "========================================="
          echo ""
          echo "Repository: $REPO"
          echo "Since: $SINCE_DAY"
          echo ""
          echo "Method: merged PRs with '$SIGNATURE' comment in PR comments; classify by number of commits after first review comment:"
          echo "- accepted_as_is: 0 commits"
          echo "- minor_changes: 1-2 commits"
          echo "- significant_changes: 3+ commits"
          echo ""

          SEARCH_NUMBERS="$(
            gh api "search/issues" \
              --paginate \
              -f q="repo:$REPO is:pr is:merged merged:>=$SINCE_DAY \"$SIGNATURE\" in:comments" \
              -F per_page=100 \
              --jq '.items[].number // empty' 2>/dev/null || true
          )"
          mapfile -t PR_NUMBERS < <(printf '%s\n' "$SEARCH_NUMBERS" | sed '/^$/d' | sort -n | uniq)
          if [ ${#PR_NUMBERS[@]} -eq 0 ] || [ -z "${PR_NUMBERS[0]:-}" ]; then
            echo "No PRs found matching criteria (this is OK; metrics will be zero)."
            PR_NUMBERS=()
          fi

          TOTAL=0
          ACCEPTED=0
          MINOR=0
          SIGNIFICANT=0
          DETAILS='[]'

          for PR_NUMBER in "${PR_NUMBERS[@]}"; do
            [ -z "$PR_NUMBER" ] && continue

            # Rate limit protection (avoid bursty loops on large PR sets)
            sleep 0.5

            # Fetch PR comments and find the earliest Merglbot review comment timestamp
            COMMENTS_JSON=$(gh api "repos/$REPO/issues/$PR_NUMBER/comments" --paginate | jq -s 'add')
            REVIEW_AT=$(echo "$COMMENTS_JSON" | jq -r --arg sig "$SIGNATURE" 'map(select(.body | contains($sig))) | min_by(.created_at) | .created_at // empty')
            if [ -z "$REVIEW_AT" ]; then
              continue
            fi

            TOTAL=$((TOTAL + 1))

            COMMITS_JSON=$(gh api "repos/$REPO/pulls/$PR_NUMBER/commits" --paginate | jq -s 'add')
            COMMITS_AFTER=$(echo "$COMMITS_JSON" | jq -r --arg review_at "$REVIEW_AT" '[.[] | select((.commit.committer.date // .commit.author.date) > $review_at)] | length')

            CLASSIFICATION="accepted_as_is"
            if [ "$COMMITS_AFTER" -eq 0 ]; then
              ACCEPTED=$((ACCEPTED + 1))
              CLASSIFICATION="accepted_as_is"
            elif [ "$COMMITS_AFTER" -le 2 ]; then
              MINOR=$((MINOR + 1))
              CLASSIFICATION="minor_changes"
            else
              SIGNIFICANT=$((SIGNIFICANT + 1))
              CLASSIFICATION="significant_changes"
            fi

            DETAILS=$(echo "$DETAILS" | jq \
              --argjson pr_number "$PR_NUMBER" \
              --arg review_at "$REVIEW_AT" \
              --argjson commits_after_review "$COMMITS_AFTER" \
              --arg classification "$CLASSIFICATION" \
              '. + [{"pr_number": $pr_number, "review_at": $review_at, "commits_after_review": $commits_after_review, "classification": $classification}]')

            echo "  PR #$PR_NUMBER: commits_after_review=$COMMITS_AFTER â†’ $CLASSIFICATION"
          done

          TIMESTAMP=$(date -u '+%Y-%m-%dT%H:%M:%SZ')
          jq -n \
            --arg timestamp "$TIMESTAMP" \
            --arg repository "$REPO" \
            --argjson period_days "$DAYS_BACK" \
            --arg since "$SINCE_DATE" \
            --argjson total_reviews "$TOTAL" \
            --argjson accepted_as_is "$ACCEPTED" \
            --argjson minor_changes "$MINOR" \
            --argjson significant_changes "$SIGNIFICANT" \
            --argjson details "$DETAILS" \
            'def pct(n):
              if $total_reviews > 0 then (((n * 1000) / $total_reviews + 0.5) | floor) / 10 else 0 end;
            {
              timestamp: $timestamp,
              repository: $repository,
              period_days: $period_days,
              since: $since,
              total_reviews: $total_reviews,
              acceptance_rate: {
                accepted_as_is: $accepted_as_is,
                accepted_as_is_percent: pct($accepted_as_is),
                minor_changes: $minor_changes,
                minor_changes_percent: pct($minor_changes),
                significant_changes: $significant_changes,
                significant_changes_percent: pct($significant_changes)
              },
              details: $details
            }' > feedback/acceptance-metrics.json

          echo ""
          echo "Acceptance metrics saved to feedback/acceptance-metrics.json"
          cat feedback/acceptance-metrics.json
      
      - name: Generate Feedback Report
        run: |
          # Create markdown report
          # NOTE: This heredoc is intentionally unquoted to allow $(date ...) expansion.
          cat > feedback/FEEDBACK_REPORT.md << REPORT_EOF
          # ðŸ“Š Merglbot PR Assistant - Feedback Report
          
          Generated: $(date -u '+%Y-%m-%d %H:%M UTC')
          
          ## Summary
          
          | Metric | Value |
          |--------|-------|
          REPORT_EOF
          
          if [ -f feedback/summary.json ]; then
            TOTAL=$(jq -r '.metrics.total_reviews' feedback/summary.json)
            UP=$(jq -r '.metrics.thumbs_up' feedback/summary.json)
            DOWN=$(jq -r '.metrics.thumbs_down' feedback/summary.json)
            SCORE=$(jq -r '.metrics.satisfaction_percent' feedback/summary.json)
            
            echo "| Total Reviews | $TOTAL |" >> feedback/FEEDBACK_REPORT.md
            echo "| ðŸ‘ Helpful | $UP |" >> feedback/FEEDBACK_REPORT.md
            echo "| ðŸ‘Ž Not Helpful | $DOWN |" >> feedback/FEEDBACK_REPORT.md
            echo "| Satisfaction | ${SCORE}% |" >> feedback/FEEDBACK_REPORT.md
          fi

          if [ -f feedback/acceptance-metrics.json ]; then
            A_TOTAL=$(jq -r '.total_reviews' feedback/acceptance-metrics.json)
            A_ACCEPTED=$(jq -r '.acceptance_rate.accepted_as_is' feedback/acceptance-metrics.json)
            A_ACCEPTED_PCT=$(jq -r '.acceptance_rate.accepted_as_is_percent' feedback/acceptance-metrics.json)
            A_MINOR=$(jq -r '.acceptance_rate.minor_changes' feedback/acceptance-metrics.json)
            A_MINOR_PCT=$(jq -r '.acceptance_rate.minor_changes_percent' feedback/acceptance-metrics.json)
            A_SIGNIFICANT=$(jq -r '.acceptance_rate.significant_changes' feedback/acceptance-metrics.json)
            A_SIGNIFICANT_PCT=$(jq -r '.acceptance_rate.significant_changes_percent' feedback/acceptance-metrics.json)

            cat >> feedback/FEEDBACK_REPORT.md << EOF

          ## Code Acceptance Rate

          **Total reviewed PRs (heuristic):** $A_TOTAL

          | Classification | Count | Percent |
          |----------------|-------|---------|
          | Accepted as-is | $A_ACCEPTED | ${A_ACCEPTED_PCT}% |
          | Minor changes | $A_MINOR | ${A_MINOR_PCT}% |
          | Significant changes | $A_SIGNIFICANT | ${A_SIGNIFICANT_PCT}% |

          EOF
          fi
          
          cat >> feedback/FEEDBACK_REPORT.md << 'REPORT_EOF'
          
          ## Insights
          
          - Reviews with no feedback may indicate users didn't find them valuable enough to react
          - Low satisfaction scores suggest prompt improvements are needed
          - High satisfaction with many reviews indicates good prompt quality
          
          ## Next Steps
          
          Based on feedback:
          1. Analyze reviews with ðŸ‘Ž reactions for common issues
          2. Compare successful vs unsuccessful review patterns
          3. Adjust prompts based on findings
          
          ---
          
          *This report is auto-generated by the Merglbot Feedback Collector workflow.*
          REPORT_EOF
          
          echo "Report generated:"
          cat feedback/FEEDBACK_REPORT.md
      
      - name: Upload Feedback Artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
        with:
          name: merglbot-feedback-${{ github.run_id }}
          path: feedback/
          retention-days: 365
      
      - name: Post Summary
        run: |
          if [ -f feedback/summary.json ]; then
            TOTAL=$(jq -r '.metrics.total_reviews' feedback/summary.json)
            UP=$(jq -r '.metrics.thumbs_up' feedback/summary.json)
            DOWN=$(jq -r '.metrics.thumbs_down' feedback/summary.json)
            SCORE=$(jq -r '.metrics.satisfaction_percent' feedback/summary.json)
            
            {
              echo "## ðŸ“Š Merglbot Feedback Report"
              echo ""
              echo "| Metric | Value |"
              echo "|--------|-------|"
              echo "| Total Reviews | $TOTAL |"
              echo "| ðŸ‘ Helpful | $UP |"
              echo "| ðŸ‘Ž Not Helpful | $DOWN |"
              echo "| Satisfaction | ${SCORE}% |"
              echo ""

              if [ -f feedback/acceptance-metrics.json ]; then
                A_TOTAL=$(jq -r '.total_reviews' feedback/acceptance-metrics.json)
                A_ACCEPTED=$(jq -r '.acceptance_rate.accepted_as_is' feedback/acceptance-metrics.json)
                A_ACCEPTED_PCT=$(jq -r '.acceptance_rate.accepted_as_is_percent' feedback/acceptance-metrics.json)
                A_MINOR=$(jq -r '.acceptance_rate.minor_changes' feedback/acceptance-metrics.json)
                A_MINOR_PCT=$(jq -r '.acceptance_rate.minor_changes_percent' feedback/acceptance-metrics.json)
                A_SIGNIFICANT=$(jq -r '.acceptance_rate.significant_changes' feedback/acceptance-metrics.json)
                A_SIGNIFICANT_PCT=$(jq -r '.acceptance_rate.significant_changes_percent' feedback/acceptance-metrics.json)

                echo "## ðŸ“ˆ Code Acceptance Rate"
                echo ""
                echo "**Total reviewed PRs (heuristic):** $A_TOTAL"
                echo ""
                echo "| Classification | Count | Percent |"
                echo "|----------------|-------|---------|"
                echo "| Accepted as-is | $A_ACCEPTED | ${A_ACCEPTED_PCT}% |"
                echo "| Minor changes | $A_MINOR | ${A_MINOR_PCT}% |"
                echo "| Significant changes | $A_SIGNIFICANT | ${A_SIGNIFICANT_PCT}% |"
                echo ""
              fi

              echo "Full report available in artifacts."
            } >> "$GITHUB_STEP_SUMMARY"
          fi
