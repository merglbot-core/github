name: Setup GCP Authentication
description: 'Authenticate to Google Cloud using Workload Identity Federation (OIDC)'

# Purpose: Centralize GCP authentication logic using WIF/OIDC (no SA JSON keys)
# Category: Composite Action
# Usage: Eliminates duplicated auth steps across 5+ deployment workflows
# Created: 2025-11-12 (Enterprise CI Audit)

inputs:
  workload_identity_provider:
    description: 'GCP Workload Identity Provider (format: projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/POOL/providers/PROVIDER)'
    required: true
  
  service_account:
    description: 'GCP Service Account email (format: SA_NAME@PROJECT_ID.iam.gserviceaccount.com)'
    required: true
  
  project_id:
    description: 'GCP Project ID (optional, for setting default project)'
    required: false
    default: ''
  
  export_environment_variables:
    description: 'Export GCP environment variables (GCLOUD_PROJECT, GCP_PROJECT, GOOGLE_CLOUD_PROJECT)'
    required: false
    default: 'true'

outputs:
  project_id:
    description: 'Effective GCP project ID resolved by the action'
    value: ${{ steps.gcloud.outputs.project_id }}

runs:
  using: composite
  steps:
    - name: Validate project input
      if: inputs.project_id != ''
      shell: bash
      run: |
        set -euo pipefail
        PROJECT_ID="${{ inputs.project_id }}"
        if ! [[ "$PROJECT_ID" =~ ^[a-z][a-z0-9-]{2,28}[a-z0-9]$ ]]; then
          echo "Invalid project_id format: $PROJECT_ID" >&2
          echo "Must start with a lowercase letter, use only lowercase letters, digits, or hyphens, be 4-30 chars long, and not end with '-'." >&2
          exit 1
        fi
    
    - name: Authenticate to Google Cloud
      id: auth
      uses: google-github-actions/auth@f112390a2df9932162083945e46d439060d66ec2  # v2.1.4
      with:
        workload_identity_provider: ${{ inputs.workload_identity_provider }}
        service_account: ${{ inputs.service_account }}
        create_credentials_file: true
        credentials_file_path: "${{ runner.temp }}/gcp-credentials.json"
        export_environment_variables: ${{ inputs.export_environment_variables }}
        cleanup_credentials: true
        token_format: 'access_token'
    
    - name: Set up Cloud SDK
      id: gcloud
      uses: google-github-actions/setup-gcloud@f0990588f1e5b5af6827153b93673613abdc6ec7  # v2.1.1
      with:
        project_id: ${{ inputs.project_id }}
    
    - name: Verify authentication
      shell: bash
      run: |
        echo "‚úÖ Authenticated as:"
        gcloud auth list --filter=status:ACTIVE --format="value(account)"
        
        EFFECTIVE_PROJECT="${{ steps.gcloud.outputs.project_id }}"
        if [ -n "$EFFECTIVE_PROJECT" ]; then
          echo "üìç Default project: $EFFECTIVE_PROJECT"
        else
          echo "üìç Default project: (not set)"
        fi
